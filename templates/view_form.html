{% extends "base.html" %}
{% block title %}{{ form.title }} - Responses{% endblock %}

{% block page_title %}
{% endblock %}

{% block page_subtitle %}
<p class="text-muted mb-0">{{ event.name }}</p>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Search Box for Verified Responses -->
        <div class="card-modern mb-4">
            <div class="card-header-modern">
                <h5 class="mb-0"><i class="bi bi-search me-2"></i>Search Verified Responses</h5>
            </div>
            <div class="card-body-modern">
                <div class="row g-3">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-qr-code"></i></span>
                            <input type="text" class="form-control form-control-modern" 
                                   id="verificationSearch" placeholder="Enter Response ID or Verification ID...">
                            <button class="btn btn-primary-modern" type="button" onclick="searchVerification()">
                                <i class="bi bi-search"></i> Search
                            </button>
                        </div>
                        <div class="form-text">
                            Search by:
                            <ul class="mb-0 mt-1 small">
                                <li><strong>Response ID:</strong> Found in responses table (e.g., "abc123def")</li>
                                <li><strong>Verification ID:</strong> From PDF (e.g., "VER-{{ form.id[:8] }}-1-abc123")</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-info" onclick="showRecentVerifications()">
                                <i class="bi bi-clock-history"></i> Recent Verifications
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Search Results -->
                <div id="searchResults" class="mt-3" style="display: none;">
                    <div class="card border-info">
                        <div class="card-header bg-info bg-opacity-10 border-info">
                            <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Search Results</h6>
                        </div>
                        <div class="card-body">
                            <div id="searchResultContent">
                                <!-- Results will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form URL and QR Code -->
        <div class="card-modern mb-4">
            <div class="card-header-modern">
                <h5 class="mb-0"><i class="bi bi-share me-2"></i>Share This Form</h5>
            </div>
            <div class="card-body-modern">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <label class="form-label fw-semibold">Form URL</label>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control form-control-modern" id="form-url" 
                                   value="{{ form_url }}" readonly>
                            <button class="btn btn-primary-modern" type="button" onclick="copyFormUrl()">
                                <i class="bi bi-copy"></i>
                            </button>
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                            <a href="{{ form_url }}" target="_blank" class="btn btn-outline-primary btn-modern">
                                <i class="bi bi-eye"></i> Preview Form
                            </a>
                            <a href="{{ url_for('share_form', event_id=event.id, form_id=form.id) }}" 
                               class="btn btn-primary-modern btn-modern">
                                <i class="bi bi-share"></i> Share
                            </a>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        {% if qr_code %}
                        <div class="mb-2">
                            <img src="{{ qr_code }}" alt="QR Code" class="img-fluid" style="max-width: 150px;">
                        </div>
                        <small class="text-muted">Scan to open form</small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {% if form.description %}
        <div class="alert alert-info mt-3">
            <div class="d-flex align-items-start">
                <i class="bi bi-info-circle me-2 mt-1"></i>
                <div>
                    <h6 class="mb-1">Form Description:</h6>
                    <p class="mb-0">{{ form.description }}</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Rest of your existing content remains the same -->
        <!-- Schedule Information Section -->
        {% if form.schedule %}
        <div class="card-modern mb-4">
            <div class="card-header-modern">
                <h5 class="mb-0"><i class="bi bi-calendar-check me-2"></i>Form Schedule</h5>
            </div>
            <div class="card-body-modern">
                <div class="row">
                    {% if form.schedule.start_datetime %}
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Opens:</label>
                        <div class="fw-semibold">
                            {{ form.schedule.start_datetime|format_date }}
                            {% set start_time = form.schedule.start_datetime|string %}
                            {% set current_time = now.isoformat() %}
                            {% if current_time < start_time %}
                            <span class="badge bg-warning ms-2">Future</span>
                            {% else %}
                            <span class="badge bg-success ms-2">Active</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if form.schedule.end_datetime %}
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Closes:</label>
                        <div class="fw-semibold">
                            {{ form.schedule.end_datetime|format_date }}
                            {% set end_time = form.schedule.end_datetime|string %}
                            {% set current_time = now.isoformat() %}
                            {% if current_time > end_time %}
                            <span class="badge bg-danger ms-2">Closed</span>
                            {% else %}
                            <span class="badge bg-success ms-2">Open</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                
                
                <!-- Form Status Alert -->
                {% set is_active, message = form|check_form_active %}
                <div class="alert alert-{{ 'success' if is_active else 'warning' }} p-3">
                    <i class="bi bi-{{ 'check-circle' if is_active else 'exclamation-triangle' }} me-2"></i>
                    <strong>{{ message }}</strong>
                    {% if not is_active %}
                    <div class="mt-1 small">Users will see a "Form Not Available" message.</div>
                    {% endif %}
                </div>
                
                <!-- Notification Status -->
                {% if form.schedule.notify_on_end %}
                <div class="alert alert-info mt-3">
                    <i class="bi bi-bell me-2"></i>
                    <strong>Email notifications enabled</strong>
                    <div class="small mt-1">
                        You'll receive an email when this form closes with response summary.
                        {% if form.schedule.notification_sent %}
                        <span class="text-success">
                            <i class="bi bi-check-circle me-1"></i>
                            Notification sent on {{ form.schedule.notification_sent_at|format_date }}
                            {% if form.schedule.response_count_at_end is defined %}
                            ({{ form.schedule.response_count_at_end }} responses)
                            {% endif %}
                        </span>
                        {% else %}
                        <span class="text-muted">
                            <i class="bi bi-clock me-1"></i>
                            Notification will be sent automatically when form closes
                        </span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                
                
                <!-- Response Count at End -->
                {% if form.schedule.response_count_at_end is defined %}
                <div class="alert alert-light mt-2">
                    <i class="bi bi-clipboard-data me-2"></i>
                    <strong>Form had {{ form.schedule.response_count_at_end }} responses when it closed</strong>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}



        <!-- Responses Table Section -->
        <div class="card-modern mb-4">
    <div class="card-header-modern d-flex justify-content-between align-items-center">
        <div>
            <h5 class="mb-0"><i class="bi bi-table me-2"></i>Responses ({{ responses|length }})</h5>
            <small class="text-muted">Session IP helps track and prevent fake submissions</small>
        </div>
        <button type="button" class="btn btn-sm btn-outline-info" 
                data-bs-toggle="modal" data-bs-target="#sessionIpInfoModal"
                title="Learn about session IP tracking">
            <i class="bi bi-info-circle me-1"></i> Learn More
        </button>
    </div>
                {% if responses|length > 0 %}
                <div class="d-flex gap-2">
                    <a href="{{ url_for('download_csv', event_id=event.id, form_id=form.id) }}" 
                       class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-download"></i> Export CSV
                    </a>
                    {% if responses|length > 0 %}
                    <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteAllResponsesModal">
                        <i class="bi bi-trash"></i> Clear All
                    </button>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            <div class="card-body-modern">
                {% if responses %}
                <div class="table-responsive">
                    <table class="table table-hover table-modern">
                        <thead>
                            <tr>
                                <th width="50">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAllResponses">
                                    </div>
                                </th>
                                <th>#</th>
                                <th>Timestamp</th>
                                <th>Response ID</th>
                                {% if responses[0] %}
                                    {% for key in responses[0].keys() %}
                                        {% if key not in ['Timestamp', 'Response ID'] %}
                                            {% if loop.index <= 3 %}
                                            <th>{{ key|truncate(20) }}</th>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for response in responses %}
                            <tr>
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input response-checkbox" type="checkbox" value="{{ response.get('Response ID', '') }}">
                                    </div>
                                </td>
                                <td>{{ loop.index }}</td>
                                <td>
                                    <small>{{ response.get('Timestamp')|format_date if response.get('Timestamp') else 'N/A' }}</small>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {% if response.get('Response ID') %}
                                            <span class="response-id-display" data-id="{{ response.get('Response ID', '') }}">
                                                {{ response['Response ID'][:8] }}...
                                            </span>
                                            <button class="btn btn-sm btn-outline-secondary btn-copy-id ms-1" 
                                                    data-id="{{ response.get('Response ID', '') }}"
                                                    title="Copy Response ID">
                                                <i class="bi bi-copy"></i>
                                            </button>
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </small>
                                </td>
                                {% if responses[0] %}
                                    {% for key, value in response.items() %}
                                        {% if key not in ['Timestamp', 'Response ID'] %}
                                            {% if loop.index <= 3 %}
                                            <td>
                                                {% if key and ('upload' in key.lower() or 'file' in key.lower() or 'photo' in key.lower() or 'image' in key.lower()) %}
                                                    {% if value %}
                                                    <span class="text-primary">
                                                        <i class="bi bi-eye"></i> Viewable
                                                    </span>
                                                    {% else %}
                                                    <span class="text-muted">-</span>
                                                    {% endif %}
                                                {% else %}
                                                    {{ value|truncate(30) if value else '-' }}
                                                {% endif %}
                                            </td>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#responseDetailModal{{ loop.index }}">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-danger delete-single-response" 
                                                data-response-id="{{ response.get('Response ID', '') }}"
                                                data-bs-toggle="tooltip" title="Delete this response">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Bulk Actions -->
                {% if responses|length > 0 %}
                <div class="mt-3 p-3 bg-light rounded d-flex justify-content-between align-items-center" id="bulkActions" style="display: none;">
                    <div>
                        <span id="selectedCount">0</span> response(s) selected
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteSelectedResponses()">
                            <i class="bi bi-trash"></i> Delete Selected
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
                            <i class="bi bi-x-circle"></i> Clear Selection
                        </button>
                    </div>
                </div>
                {% endif %}
                
                <!-- Response Detail Modals -->
                {% for response in responses %}
                <div class="modal fade" id="responseDetailModal{{ loop.index }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-person-badge me-2"></i>Response Details
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <!-- Hidden data for QR code -->
                                <input type="hidden" class="qr-code-data" value="{{ response._qr_code if response._qr_code else '' }}">
                                <input type="hidden" class="verification-url" value="{{ response._verification_url if response._verification_url else '' }}">
                                <input type="hidden" class="response-id" value="{{ response.get('Response ID', '') }}">
                                
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h6 class="card-title">Response Information</h6>
                                                <p class="mb-1"><strong>Submitted:</strong> {{ response.get('Timestamp')|format_date if response.get('Timestamp') else 'N/A' }}</p>
                                                <p class="mb-1"><strong>Response ID:</strong> 
                                                    <span class="response-id-display" data-id="{{ response.get('Response ID', '') }}">
                                                        {{ response.get('Response ID', 'N/A') }}
                                                    </span>
                                                    <button class="btn btn-sm btn-outline-secondary btn-copy-id ms-1" 
                                                            data-id="{{ response.get('Response ID', '') }}"
                                                            title="Copy Response ID">
                                                        <i class="bi bi-copy"></i>
                                                    </button>
                                                </p>
                                                <p class="mb-0"><strong>Entry #:</strong> {{ loop.index }}</p>
                                                <p class="mb-0 mt-2">
                                                    <strong>Verification ID:</strong> 
                                                    <code>VER-{{ form.id[:8] }}-{{ loop.index }}-{{ response.get('Response ID', '00000000')[:8] }}</code>
                                                </p>
                                                
                                                <!-- QR Code Preview -->
                                                {% if response._qr_code %}
                                                <div class="mt-3 pt-3 border-top">
                                                    <h6 class="card-title">Verification QR Code</h6>
                                                    <div class="text-center">
                                                        <img src="{{ response._qr_code }}" alt="Verification QR Code" class="img-fluid" style="max-width: 150px;">
                                                        <small class="text-muted d-block mt-2">Scan to verify authenticity</small>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h6 class="card-title">Quick Actions</h6>
                                                <div class="d-flex flex-column gap-2">
                                                
                                                
                                                
                                                    {% for key, value in response.items() %}
                                                        {% if key and ('upload' in key.lower() or 'file' in key.lower() or 'photo' in key.lower() or 'image' in key.lower()) %}
                                                            {% if value %}
                                                            <a href="{{ url_for('download_file', event_id=event.id, form_id=form.id, filename=value) }}" 
                                                               class="btn btn-sm btn-outline-primary text-start" target="_blank" rel="noopener noreferrer">
                                                                <i class="bi bi-eye"></i> View File
                                                            </a>
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                    <a href="{{ url_for('verify_response', event_id=event.id, form_id=form.id, response_id=response.get('Response ID', '')) }}" 
                                                       class="btn btn-sm btn-outline-success text-start" target="_blank">
                                                        <i class="bi bi-qr-code-scan"></i> Verify Response
                                                    </a>
                                                    <button class="btn btn-sm btn-outline-info text-start" 
                                                            onclick="copyToSearch('{{ response.get('Response ID', '') }}')">
                                                        <i class="bi bi-search"></i> Search This ID
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger text-start delete-single-response" 
                                                            data-response-id="{{ response.get('Response ID', '') }}">
                                                        <i class="bi bi-trash"></i> Delete Response
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <h6 class="mb-3">Response Details:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th width="30%">Question</th>
                                                <th>Answer</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for key, value in response.items() %}
                                            {% if key not in ['Timestamp', 'Response ID', '_qr_code', '_verification_url'] %}
                                            <tr>
                                                <td class="fw-semibold">{{ key }}</td>
                                                <td>
                                                    {% if key and ('upload' in key.lower() or 'file' in key.lower() or 'photo' in key.lower() or 'image' in key.lower()) %}
                                                        {% if value %}
                                                        <div class="d-flex align-items-center">
                                                            <i class="bi bi-file-earmark me-2"></i>
                                                            <div>
                                                                <a href="{{ url_for('download_file', event_id=event.id, form_id=form.id, filename=value) }}" 
                                                                   class="text-decoration-none" target="_blank" rel="noopener noreferrer">
                                                                    {{ value }}
                                                                </a>
                                                                <small class="d-block text-muted">Click to view (opens in new window)</small>
                                                                
                                                                {% set file_ext = value|lower %}
                                                                {% if file_ext.endswith('.jpg') or file_ext.endswith('.jpeg') or file_ext.endswith('.png') or file_ext.endswith('.gif') or file_ext.endswith('.bmp') or file_ext.endswith('.webp') or file_ext.endswith('.svg') %}
                                                                <div class="mt-2">
                                                                    <div class="border rounded p-2 bg-light">
                                                                        <small class="text-muted d-block mb-1">Preview:</small>
                                                                        <img src="{{ url_for('download_file', event_id=event.id, form_id=form.id, filename=value) }}" 
                                                                             alt="Preview" class="img-fluid rounded" style="max-height: 150px; cursor: pointer;"
                                                                             onclick="window.open('{{ url_for('download_file', event_id=event.id, form_id=form.id, filename=value) }}', '_blank')"
                                                                             onerror="this.style.display='none'">
                                                                        <small class="d-block text-muted mt-1">Click image to view full size</small>
                                                                    </div>
                                                                </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        {% else %}
                                                        <span class="text-muted">No file uploaded</span>
                                                        {% endif %}
                                                    {% else %}
                                                        <div style="max-height: 150px; overflow-y: auto;">
                                                            {{ value if value else '<span class="text-muted">Not provided</span>'|safe }}
                                                        </div>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <!-- In the responseDetailModal footer (around line 520-530 in your code) -->
<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
    
    <!-- Keep existing Print button -->
    <button type="button" class="btn btn-primary" 
            onclick="printResponse('responseDetailModal{{ loop.index }}', {{ loop.index }})" 
            id="printBtn{{ loop.index }}">
        <i class="bi bi-printer"></i> Print with QR Code
    </button>
</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                <!-- Pagination -->
                {% if responses|length > 10 %}
                <nav aria-label="Responses navigation" class="mt-4">
                    <ul class="pagination justify-content-center">
                        <li class="page-item disabled">
                            <span class="page-link">Showing {{ responses|length }} of {{ responses|length }} responses</span>
                        </li>
                    </ul>
                </nav>
                {% endif %}
                
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-4 text-muted mb-3"></i>
                    <h5 class="text-muted">No responses yet</h5>
                    <p class="text-muted mb-4">Share the form URL to start collecting responses</p>
                    <div class="d-flex justify-content-center gap-2">
                        <a href="{{ url_for('share_form', event_id=event.id, form_id=form.id) }}" 
                           class="btn btn-primary-modern">
                            <i class="bi bi-envelope"></i> Email Form
                        </a>
                        <button onclick="copyFormUrl()" class="btn btn-outline-primary">
                            <i class="bi bi-link"></i> Copy Form URL
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Actions -->
        <div class="card-modern mb-4">
            <div class="card-header-modern">
                <h5 class="mb-0"><i class="bi bi-lightning-charge me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body-modern">
                <div class="row g-3">
                    <div class="col-md-4">
                        <a href="{{ url_for('share_form', event_id=event.id, form_id=form.id) }}" 
                           class="btn btn-primary-modern w-100 btn-modern">
                            <i class="bi bi-envelope"></i> Email Form
                        </a>
                    </div>
                    <div class="col-md-4">
    <a href="{{ url_for('download_csv_with_ip', event_id=event.id, form_id=form.id) }}" 
                           class="btn btn-outline-primary w-100 btn-modern">
                            <i class="bi bi-download"></i> Export CSV
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="{{ url_for('generate_pro_pdf', event_id=event.id, form_id=form.id) }}" 
                           class="btn btn-outline-primary w-100 btn-modern">
                            <i class="bi bi-file-pdf"></i> Export PDF
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="{{ url_for('view_pro_pdf', event_id=event.id, form_id=form.id) }}" 
                           class="btn btn-outline-primary w-100 btn-modern">
                            <i class="bi bi-eye"></i> View PDF Report
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="{{ url_for('view_uploads', event_id=event.id, form_id=form.id) }}" 
                           class="btn btn-outline-secondary w-100 btn-modern">
                            <i class="bi bi-folder"></i> View Uploads
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="{{ url_for('debug_share_form_email', event_id=event.id, form_id=form.id, email=session.email) }}" 
                           class="btn btn-outline-info w-100 btn-modern">
                            <i class="bi bi-bug"></i> Test Email
                        </a>
                    </div>
                    
                    {% if form.schedule and form.schedule.end_datetime %}
                    <div class="col-12">
                        <div class="alert alert-warning p-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <small>
                                <strong>Form Schedule:</strong> This form will automatically 
                                {% set current_time = now.isoformat() %}
                                {% set end_time = form.schedule.end_datetime|string %}
                                {% if current_time > end_time %}
                                closed on {{ form.schedule.end_datetime|format_date }}
                                {% else %}
                                close on {{ form.schedule.end_datetime|format_date }}
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Volunteer Mode Section -->
    <div class="col-lg-4">
        <!-- Volunteer Mode Section -->
        <div class="card-modern mb-4">
            <div class="card-header-modern d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-people me-2"></i>Volunteer Mode</h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="volunteerModeToggle" onchange="toggleVolunteerMode()">
                    <label class="form-check-label" for="volunteerModeToggle">
                        <span id="volunteerModeStatus" class="text-muted">Disabled</span>
                    </label>
                </div>
            </div>
            <div class="card-body-modern" id="volunteerModeContent" style="display: none;">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="bi bi-shield-lock me-2"></i> Volunteer Access Code
                                </h6>
                                
                                <div id="volunteerCodeContainer" class="text-center mb-3">
                                    <div class="display-4 font-monospace fw-bold text-primary mb-2" 
                                         id="volunteerCodeDisplay">
                                        -------- --------
                                    </div>
                                    <div class="mb-3">
                                        <small class="text-muted">16-digit alphanumeric code</small>
                                        <div class="form-text">Expires in 24 hours</div>
                                    </div>
                                    <div class="d-flex gap-2 justify-content-center">
                                        <button class="btn btn-primary" onclick="copyVolunteerCode()" 
                                                id="copyCodeBtn" disabled>
                                            <i class="bi bi-clipboard me-1"></i> Copy Code
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="generateNewCode()">
                                            <i class="bi bi-arrow-clockwise me-1"></i> Generate New
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Share this code with volunteers for event day verification.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="bi bi-link me-2"></i> Volunteer Access Link
                                </h6>
                                
                                <div class="mb-3">
                                    <label class="form-label">Direct Access Link</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="volunteerLink" 
                                               readonly value="">
                                        <button class="btn btn-outline-primary" type="button" 
                                                onclick="copyVolunteerLink()" id="copyLinkBtn" disabled>
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        Volunteers can use this link to access the verification system
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Volunteer Instructions</label>
                                    <div class="alert alert-warning small">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        <strong>Instructions for volunteers:</strong>
                                        <ol class="mb-0 mt-1">
                                            <li>Open the access link on any device</li>
                                            <li>Enter the 16-digit code when prompted</li>
                                            <li>Provide your name for identification</li>
                                            <li>You'll see all registered participants</li>
                                            <li>Search and verify participants as they arrive</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Active Volunteers -->
                <div class="mt-4" id="activeVolunteersSection" style="display: none;">
                    <h6 class="mb-3"><i class="bi bi-person-check me-2"></i>Active Volunteers</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Code</th>
                                    <th>First Access</th>
                                    <th>Last Access</th>
                                    <th>Access Count</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="volunteersList">
                                <!-- Volunteers will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Volunteer Statistics -->
                <div class="row mt-3">
                    <div class="col-md-4">
                        <div class="card bg-primary bg-opacity-10">
                            <div class="card-body text-center">
                                <div class="display-6 fw-bold" id="volunteerCount">0</div>
                                <small class="text-muted">Active Volunteers</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-success bg-opacity-10">
                            <div class="card-body text-center">
                                <div class="display-6 fw-bold" id="totalAccesses">0</div>
                                <small class="text-muted">Total Accesses</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-info bg-opacity-10">
                            <div class="card-body text-center">
                                <div class="display-6 fw-bold" id="lastAccess">--:--</div>
                                <small class="text-muted">Last Access</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Information -->
        <div class="card-modern mb-4">
            <div class="card-header-modern">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Form Information</h5>
            </div>
            <div class="card-body-modern">
                <div class="row">
                    <div class="col-6 mb-3">
                        <label class="form-label text-muted">Created</label>
                        <div class="fw-semibold">{{ form.created_at|format_date }}</div>
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label text-muted">Questions</label>
                        <div class="fw-semibold">{{ form.questions|length }}</div>
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label text-muted">Responses</label>
                        <div class="fw-semibold">{{ responses|length }}</div>
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label text-muted">Status</label>
                        <div class="fw-semibold">
                            {% set is_active, message = is_form_active(form) %}
                            <span class="badge bg-{{ 'success' if is_active else 'danger' }}">
                                {{ 'Active' if is_active else 'Inactive' }}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6>Questions Preview:</h6>
                    <ul class="list-group list-group-flush">
                        {% for question in form.questions[:5] %}
                        <li class="list-group-item border-0 px-0 py-2">
                            <div class="d-flex justify-content-between">
                                <span>{{ question.text|truncate(30) }}</span>
                                <span class="badge bg-light text-dark">
                                    {{ question.type|title }}
                                    {% if question.required %}
                                    <span class="text-danger ms-1">*</span>
                                    {% endif %}
                                </span>
                            </div>
                        </li>
                        {% endfor %}
                        {% if form.questions|length > 5 %}
                        <li class="list-group-item border-0 px-0 py-2 text-center">
                            <small class="text-muted">+ {{ form.questions|length - 5 }} more questions</small>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="card-modern mb-4">
            <div class="card-header-modern">
                <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>Quick Stats</h5>
            </div>
            <div class="card-body-modern">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="display-6 fw-bold text-primary">{{ responses|length }}</div>
                        <small class="text-muted">Total Responses</small>
                    </div>
                    <div class="col-6 mb-3">
                        {% set file_count = 0 %}
                        {% for response in responses %}
                            {% for key, value in response.items() %}
                                {% if key and ('upload' in key.lower() or 'file' in key.lower()) %}
                                    {% if value %}
                                        {% set file_count = file_count + 1 %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                        <div class="display-6 fw-bold text-info">{{ file_count }}</div>
                        <small class="text-muted">Files Uploaded</small>
                    </div>
                    <div class="col-6">
                        <div class="display-6 fw-bold text-warning">{{ form.questions|length }}</div>
                        <small class="text-muted">Questions</small>
                    </div>
                    <div class="col-6">
                        {% set required_count = 0 %}
                        {% for question in form.questions %}
                            {% if question.required %}
                                {% set required_count = required_count + 1 %}
                            {% endif %}
                        {% endfor %}
                        <div class="display-6 fw-bold text-danger">{{ required_count }}</div>
                        <small class="text-muted">Required</small>
                    </div>
                </div>
                
                {% if responses|length > 0 %}
                <div class="mt-3">
                    <small class="text-muted">Latest response:</small>
                    <div class="fw-semibold">
                        {% set last_response = responses|last %}
                        {% if last_response.get('Timestamp') %}
                            {{ last_response.get('Timestamp')|format_date|relative_time }}
                        {% else %}
                            N/A
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Schedule Summary Card -->
        {% if form.schedule %}
        <div class="card-modern">
            <div class="card-header-modern">
                <h5 class="mb-0"><i class="bi bi-calendar-week me-2"></i>Schedule Summary</h5>
            </div>
            <div class="card-body-modern">
                {% if form.schedule.start_datetime %}
                <div class="d-flex align-items-center mb-3">
                    <div class="me-3">
                        <span class="badge bg-success rounded-circle p-2">
                            <i class="bi bi-calendar-check"></i>
                        </span>
                    </div>
                    <div>
                        <small class="text-muted">Opens</small>
                        <div class="fw-semibold">{{ form.schedule.start_datetime|format_date }}</div>
                    </div>
                </div>
                {% endif %}
                
                {% if form.schedule.end_datetime %}
                <div class="d-flex align-items-center mb-3">
                    <div class="me-3">
                        <span class="badge bg-danger rounded-circle p-2">
                            <i class="bi bi-calendar-x"></i>
                        </span>
                    </div>
                    <div>
                        <small class="text-muted">Closes</small>
                        <div class="fw-semibold">{{ form.schedule.end_datetime|format_date }}</div>
                    </div>
                </div>
                {% endif %}
                
                {% if form.schedule.notify_on_end %}
                <div class="d-flex align-items-center mb-3">
                    <div class="me-3">
                        <span class="badge bg-info rounded-circle p-2">
                            <i class="bi bi-bell"></i>
                        </span>
                    </div>
                    <div>
                        <small class="text-muted">Email Notification</small>
                        <div class="fw-semibold">
                            {% if form.schedule.notification_sent %}
                            Sent on {{ form.schedule.notification_sent_at|format_date }}
                            {% else %}
                            Will be sent when form closes
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if form.schedule.notify_on_end and not form.schedule.notification_sent %}
                <div class="mt-3">
                    <button class="btn btn-outline-info w-100 btn-modern" 
                            onclick="sendTestNotification('{{ event.id }}', '{{ form.id }}')">
                        <i class="bi bi-bell"></i> Send Test Notification
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        
        {% if form.schedule and form.schedule.notify_on_end == True %}
        <div class="mt-3">
            <button class="btn btn-outline-warning w-100 btn-modern" 
                    onclick="sendTestNotification('{{ event.id }}', '{{ form.id }}')">
                <i class="bi bi-bell"></i> Send Test Notification
            </button>
            <small class="text-muted d-block mt-1">
                Send a test form-end notification to your email ({{ session.email }})
            </small>
        </div>
        {% endif %}
        {% endif %}
        
        <!-- Edit and Delete Form Buttons -->
        <div class="d-flex gap-2 mt-3">
            <a href="{{ url_for('edit_form_page', event_id=event.id, form_id=form.id) }}" 
               class="btn btn-warning btn-modern">
                <i class="bi bi-pencil-square me-2"></i> Edit Form
            </a>
            <button class="btn btn-danger btn-modern" 
                    data-bs-toggle="modal" 
                    data-bs-target="#deleteFormModal">
                <i class="bi bi-trash me-2"></i> Delete Form
            </button>
        </div>
    </div>
</div>

<!-- Delete Form Modal -->
<div class="modal fade" id="deleteFormModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Delete Form</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-octagon me-2"></i>
                    <strong>Warning: This action cannot be undone!</strong>
                </div>
                <p>You are about to delete the form: <strong>{{ form.title }}</strong></p>
                
                <div class="card bg-light mb-3">
                    <div class="card-body">
                        <h6>What will be deleted:</h6>
                        <ul class="mb-0">
                            <li>Form configuration ({{ form.questions|length }} questions)</li>
                            <li>{{ responses|length }} response(s)</li>
                            <li>All uploaded files</li>
                            <li>Form schedule and settings</li>
                        </ul>
                    </div>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirmDelete">
                    <label class="form-check-label fw-semibold" for="confirmDelete">
                        I understand that this action cannot be undone
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteFormButton" disabled>
                    <i class="bi bi-trash"></i> Delete Form Permanently
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete All Responses Modal -->
<div class="modal fade" id="deleteAllResponsesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Clear All Responses</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Warning: This will remove all response data!</strong>
                </div>
                <p>You are about to delete all {{ responses|length }} responses from the form: <strong>{{ form.title }}</strong></p>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirmDeleteAll">
                    <label class="form-check-label fw-semibold" for="confirmDeleteAll">
                        I want to delete all responses (this cannot be undone)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteAllResponsesButton" disabled>
                    <i class="bi bi-trash"></i> Clear All Responses
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Session IP Information Modal -->
<div class="modal fade" id="sessionIpInfoModal" tabindex="-1" aria-labelledby="sessionIpInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="sessionIpInfoModalLabel">
                    <i class="bi bi-shield-lock me-2"></i>Session IP Tracking
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <h5 class="text-info">
                            <i class="bi bi-question-circle me-2"></i>What is an IP Address?
                        </h5>
                        <p>
                            An <strong>IP (Internet Protocol) address</strong> is like a digital home address for devices connected to the internet. 
                            Every device (computer, phone, tablet) gets a unique IP address when it connects to the internet, 
                            allowing data to be sent to and received from the correct location.
                        </p>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-lightbulb me-2"></i>
                            <strong>Note:</strong> IP addresses are automatically detected by our system and cannot be manually changed by users.
                        </div>
                        
                        <!-- Understanding IP Address Structure -->
                        <h5 class="text-info mt-4">
                            <i class="bi bi-diagram-3 me-2"></i>Understanding IP Address Structure (IPv4 / IPv6)
                        </h5>
                        
                        <div class="row mt-3">
                            <div class="col-md-6 mb-3">
                                <div class="card border-info h-100">
                                    <div class="card-body">
                                        <h6 class="card-title text-info">
                                            <i class="bi bi-puzzle me-2"></i>IPv4 Address Format
                                        </h6>
                                        <div class="text-center mb-3">
                                            <div class="display-6 font-monospace text-primary">192.168.1.100</div>
                                            <small class="text-muted">Example IPv4 Address</small><br>
                                            <small class="text-muted">Note: In some cases, especially on mobile networks, the system may record an IPv6 address instead of IPv4.</small>
                                        </div>
                                        <p class="card-text">
                                            <strong>Format:</strong> Four numbers separated by dots
                                            <br><strong>Range:</strong> 0.0.0.0 to 255.255.255.255
                                            <br><strong>Parts:</strong>
                                            <ul class="small mb-0">
                                                <li><strong>First 3 numbers:</strong> Network identifier</li>
                                                <li><strong>Last number:</strong> Device identifier</li>
                                            </ul>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <div class="card border-info h-100">
                                    <div class="card-body">
                                        <h6 class="card-title text-info">
                                            <i class="bi bi-globe me-2"></i>What IP Reveals
                                        </h6>
                                        <p class="card-text">
                                            <strong>IP addresses can indicate:</strong>
                                            <ul class="mb-3">
                                                <li><strong>Geographic location</strong> (country, city, region)</li>
                                                <li><strong>Internet Service Provider</strong> (ISP)</li>
                                                <li><strong>Network type</strong> (home, business, mobile)</li>
                                            </ul>
                                            <div class="alert alert-warning small mb-0">
                                                <i class="bi bi-exclamation-triangle me-2"></i>
                                                <strong>Note:</strong> IP alone cannot identify individuals by name, address, or phone number.
                                            </div>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bash Commands for Investigation -->
                        <div class="alert alert-dark mt-4">
                            <h6 class="mb-3">
                                <i class="bi bi-terminal me-2"></i>Terminal/Bash Commands for IP Investigation
                            </h6>
                            <p class="mb-3">Use these commands in Linux/Mac Terminal or Windows WSL/PowerShell:</p>
                            
                            <div class="card bg-dark text-light mb-3">
                                <div class="card-header font-monospace">
                                    # 1. WHOIS Lookup (Most Important)
                                </div>
                                <div class="card-body">
                                    <code class="text-info">whois 185.220.101.37</code>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-light copy-btn" data-code="whois 185.220.101.37">
                                            <i class="bi bi-clipboard"></i> Copy
                                        </button>
                                        <small class="ms-2 text-muted">Replace IP with suspicious address</small>
                                    </div>
                                    <div class="alert alert-secondary small mt-2 mb-0">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Shows organization, country, ISP, and abuse contact info
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card bg-dark text-light mb-3">
                                <div class="card-header font-monospace">
                                    # 2. Ping Check (Is the device online?)
                                </div>
                                <div class="card-body">
                                    <code class="text-info">ping -c 4 185.220.101.37</code>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-light copy-btn" data-code="ping -c 4 185.220.101.37">
                                            <i class="bi bi-clipboard"></i> Copy
                                        </button>
                                        <small class="ms-2 text-muted">Windows: <code>ping -n 4 185.220.101.37</code></small>
                                    </div>
                                    <div class="alert alert-secondary small mt-2 mb-0">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Checks if device responds. No response often means VPN/proxy.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card bg-dark text-light mb-3">
                                <div class="card-header font-monospace">
                                    # 3. Traceroute (Network path analysis)
                                </div>
                                <div class="card-body">
                                    <code class="text-info">traceroute 185.220.101.37</code>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-light copy-btn" data-code="traceroute 185.220.101.37">
                                            <i class="bi bi-clipboard"></i> Copy
                                        </button>
                                        <small class="ms-2 text-muted">Windows: <code>tracert 185.220.101.37</code></small>
                                    </div>
                                    <div class="alert alert-secondary small mt-2 mb-0">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Shows network hops. Many hops through unknown countries = suspicious.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card bg-dark text-light mb-3">
                                <div class="card-header font-monospace">
                                    # 4. Reverse DNS Lookup
                                </div>
                                <div class="card-body">
                                    <code class="text-info">nslookup 185.220.101.37</code>
                                    <br><code class="text-info">dig -x 185.220.101.37</code>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-light copy-btn" data-code="nslookup 185.220.101.37">
                                            <i class="bi bi-clipboard"></i> Copy
                                        </button>
                                        <button class="btn btn-sm btn-outline-light copy-btn ms-2" data-code="dig -x 185.220.101.37">
                                            <i class="bi bi-clipboard"></i> Copy
                                        </button>
                                    </div>
                                    <div class="alert alert-secondary small mt-2 mb-0">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Gets hostname. Names like "vpn-", "proxy-", "tor-" are red flags.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card bg-dark text-light">
                                <div class="card-header font-monospace">
                                    # 5. Quick Multi-Tool Check
                                </div>
                                <div class="card-body">
                                    <code class="text-info">curl -s https://ipapi.co/185.220.101.37/json/ | python3 -m json.tool</code>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-light copy-btn" data-code="curl -s https://ipapi.co/185.220.101.37/json/ | python3 -m json.tool">
                                            <i class="bi bi-clipboard"></i> Copy
                                        </button>
                                    </div>
                                    <div class="alert alert-secondary small mt-2 mb-0">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Gets JSON with country, city, ISP, VPN detection (requires curl & python)
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Windows PowerShell Section -->
                        <div class="alert alert-secondary mt-4">
                            <h6 class="mb-3">
                                <i class="bi bi-windows me-2"></i>Windows PowerShell Commands
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card bg-secondary text-light mb-3">
                                        <div class="card-header font-monospace">
                                            PowerShell: WHOIS Alternative
                                        </div>
                                        <div class="card-body">
                                            <code class="text-info">Invoke-RestMethod -Uri "http://ip-api.com/json/185.220.101.37" | ConvertTo-Json</code>
                                            <div class="mt-2">
                                                <button class="btn btn-sm btn-outline-light copy-btn" data-code='Invoke-RestMethod -Uri "http://ip-api.com/json/185.220.101.37" | ConvertTo-Json'>
                                                    <i class="bi bi-clipboard"></i> Copy
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card bg-secondary text-light mb-3">
                                        <div class="card-header font-monospace">
                                            PowerShell: Quick Check
                                        </div>
                                        <div class="card-body">
                                            <code class="text-info">Test-NetConnection 185.220.101.37 -TraceRoute</code>
                                            <div class="mt-2">
                                                <button class="btn btn-sm btn-outline-light copy-btn" data-code="Test-NetConnection 185.220.101.37 -TraceRoute">
                                                    <i class="bi bi-clipboard"></i> Copy
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- For Form Creators: Spotting Fake Submissions -->
                        <h5 class="text-info mt-4">
                            <i class="bi bi-eye me-2"></i>For Form Creators: How to Spot Fake Submissions
                        </h5>
                        
                        <div class="alert alert-warning">
                            <i class="bi bi-shield-exclamation me-2"></i>
                            <strong>Pro Tip:</strong> Use these patterns in the Session IP column to identify potentially fake submissions
                        </div>
                        
                        <div class="table-responsive mt-3">
                            <table class="table table-sm table-bordered">
                                <thead class="table-warning">
                                    <tr>
                                        <th width="25%">Suspicious Pattern</th>
                                        <th width="35%">What to Look For</th>
                                        <th width="25%">Why It's Suspicious</th>
                                        <th width="15%">Risk Level</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="fw-semibold">Multiple Same IP</td>
                                        <td>10+ submissions from identical IP<br><code class="small">192.168.1.100</code></td>
                                        <td>Single device submitting many responses</td>
                                        <td><span class="badge bg-danger">High</span></td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Sequential IPs</td>
                                        <td>Consecutive IP addresses<br><code class="small">192.168.1.100  192.168.1.101  192.168.1.102</code></td>
                                        <td>Bot automation or scripted submissions</td>
                                        <td><span class="badge bg-danger">High</span></td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">VPN/Proxy IPs</td>
                                        <td>Known VPN services<br><code class="small">104.200.131.X</code> (common VPN range)</td>
                                        <td>Users hiding real location</td>
                                        <td><span class="badge bg-warning">Medium</span></td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">International IPs</td>
                                        <td>Foreign countries for local events<br><code class="small">185.220.101.X</code> (Germany)</td>
                                        <td>Unlikely geographic mismatch</td>
                                        <td><span class="badge bg-warning">Medium</span></td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Data Center IPs</td>
                                        <td>Cloud/VPS providers<br><code class="small">AWS, Google Cloud, Azure ranges</code></td>
                                        <td>Bot farms or automated systems</td>
                                        <td><span class="badge bg-danger">High</span></td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Rapid Submissions</td>
                                        <td>Same IP within seconds/minutes<br><code class="small">5 responses in 30 seconds</code></td>
                                        <td>Humanly impossible submission speed</td>
                                        <td><span class="badge bg-danger">High</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Cheat Sheet -->
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <i class="bi bi-card-checklist me-2"></i>Bash Investigation Cheat Sheet
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Command</th>
                                                    <th>What it Finds</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td><code>whois</code></td>
                                                    <td>Organization & Abuse Contact</td>
                                                </tr>
                                                <tr>
                                                    <td><code>ping</code></td>
                                                    <td>Device Responsiveness</td>
                                                </tr>
                                                <tr>
                                                    <td><code>traceroute</code></td>
                                                    <td>Network Path</td>
                                                </tr>
                                                <tr>
                                                    <td><code>nslookup</code></td>
                                                    <td>Hostname/Reverse DNS</td>
                                                </tr>
                                                <tr>
                                                    <td><code>curl ipapi.co</code></td>
                                                    <td>Full Geolocation</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <i class="bi bi-exclamation-triangle me-2"></i>Red Flags in WHOIS Output
                                    </div>
                                    <div class="card-body">
                                        <ul class="mb-0">
                                            <li><strong>"Amazon Technologies"</strong> = AWS server (bot)</li>
                                            <li><strong>"TOR-EXIT-NODE"</strong> = Tor anonymity network</li>
                                            <li><strong>"VPN" in organization</strong> = VPN service</li>
                                            <li><strong>"Hosting" or "Data Center"</strong> = Server farm</li>
                                            <li><strong>"Abuse Contact" generic</strong> = Difficult to report</li>
                                            <li><strong>Multiple countries in path</strong> = Proxy chain</li>
                                        </ul>
                                        <div class="alert alert-info small mt-3 mb-0">
                                            <i class="bi bi-lightbulb me-1"></i>
                                            Copy IP from CSV  Run <code>whois IP_ADDRESS</code>  Look for these patterns
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Checklist for Form Creators -->
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card bg-light border-warning">
                                    <div class="card-body">
                                        <h6 class="card-title text-warning">
                                            <i class="bi bi-check-square me-2"></i>Red Flags Checklist
                                        </h6>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="check1" disabled>
                                            <label class="form-check-label small" for="check1">
                                                <strong>Same IP, different names</strong> - One device, multiple identities
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="check2" disabled>
                                            <label class="form-check-label small" for="check2">
                                                <strong>Patterned emails</strong> - user1@mail.com, user2@mail.com
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="check3" disabled>
                                            <label class="form-check-label small" for="check3">
                                                <strong>Gibberish data</strong> - Random text in name/email fields
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="check4" disabled>
                                            <label class="form-check-label small" for="check4">
                                                <strong>Impossible timestamps</strong> - Multiple submissions at exact same second
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card bg-light border-success">
                                    <div class="card-body">
                                        <h6 class="card-title text-success">
                                            <i class="bi bi-clipboard-check me-2"></i>Verification Steps
                                        </h6>
                                        <ol class="small mb-0">
                                            <li><strong>Sort CSV by IP</strong> - Group submissions by IP address</li>
                                            <li><strong>Check timestamps</strong> - Look for rapid consecutive submissions</li>
                                            <li><strong>Compare data</strong> - Similar answers from same IP</li>
                                            <li><strong>Validate geography</strong> - IP location vs. event location</li>
                                            <li><strong>Investigate patterns</strong> - Systematic fake data patterns</li>
                                        </ol>
                                        <div class="alert alert-info small mt-3 mb-0">
                                            <i class="bi bi-tools me-1"></i>
                                            Use the "Export CSV with Session IP" button to get detailed IP data
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- IP Address Examples -->
                        <h5 class="text-info mt-4">
                            <i class="bi bi-code-slash me-2"></i>IP Address Examples & Analysis
                        </h5>
                        
                        <div class="table-responsive mt-3">
                            <table class="table table-sm table-bordered">
                                <thead class="table-info">
                                    <tr>
                                        <th width="25%">IP Address Example</th>
                                        <th width="30%">What It Might Indicate</th>
                                        <th width="25%">Likely Source</th>
                                        <th width="20%">Trust Level</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code>192.168.1.105</code></td>
                                        <td>Home/office network (private IP)</td>
                                        <td>Legitimate user on local network</td>
                                        <td><span class="badge bg-success">High</span></td>
                                    </tr>
                                    <tr>
                                        <td><code>104.28.245.93</code></td>
                                        <td>Cloudflare proxy (common for websites)</td>
                                        <td>User behind CDN/proxy service</td>
                                        <td><span class="badge bg-warning">Medium</span></td>
                                    </tr>
                                    <tr>
                                        <td><code>185.220.101.37</code></td>
                                        <td>German IP (Tor exit node)</td>
                                        <td>VPN/Tor anonymity network</td>
                                        <td><span class="badge bg-danger">Low</span></td>
                                    </tr>
                                    <tr>
                                        <td><code>54.240.197.215</code></td>
                                        <td>Amazon AWS data center</td>
                                        <td>Cloud server/bot hosting</td>
                                        <td><span class="badge bg-danger">Low</span></td>
                                    </tr>
                                    <tr>
                                        <td><code>223.230.76.102</code></td>
                                        <td>Indian mobile carrier</td>
                                        <td>Legitimate mobile user</td>
                                        <td><span class="badge bg-success">High</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Example Investigation -->
                        <div class="mt-4 p-3 bg-dark text-light rounded">
                            <h6 class="text-info">
                                <i class="bi bi-terminal me-2"></i>Real Investigation Example
                            </h6>
                            <p>Investigating suspicious IP <code>185.220.101.37</code>:</p>
                            
                            <div class="font-monospace small bg-black p-3 rounded">
                                <span class="text-success">$</span> whois 185.220.101.37<br>
                                <span class="text-muted">inetnum:        185.220.101.32 - 185.220.101.63</span><br>
                                <span class="text-muted">netname:        TOR-EXIT-NODE</span><br>
                                <span class="text-muted">descr:          Tor Exit Node</span><br>
                                <span class="text-muted">country:        DE</span><br>
                                <span class="text-muted">organisation:   Zwiebelfreunde e.V.</span><br>
                                <span class="text-muted">abuse-mailbox:  abuse@zwiebelfreunde.de</span><br><br>
                                
                                <span class="text-success">$</span> nslookup 185.220.101.37<br>
                                <span class="text-muted">37.101.220.185.in-addr.arpa name = tor-exit-37.zwiebelfreunde.de.</span><br><br>
                                
                                <span class="text-success">$</span> ping -c 2 185.220.101.37<br>
                                <span class="text-muted">64 bytes from 185.220.101.37: icmp_seq=1 ttl=50 time=95.6 ms</span><br>
                                <span class="text-muted">64 bytes from 185.220.101.37: icmp_seq=2 ttl=50 time=96.1 ms</span>
                            </div>
                            
                            <div class="alert alert-warning mt-3 mb-0">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Conclusion:</strong> This is a Tor Exit Node in Germany. All submissions from this IP are using anonymity network = HIGH RISK
                            </div>
                        </div>
                        
                        <!-- Quick Script for Multiple IPs -->
                        <div class="mt-4">
                            <h6 class="text-info">
                                <i class="bi bi-file-code me-2"></i>Quick Bash Script for Multiple IPs
                            </h6>
                            <p>Save this as <code>check_ips.sh</code> to investigate multiple IPs from your CSV:</p>
                            
                            <div class="card bg-dark text-light">
                                <div class="card-body">
                                    <pre class="text-info mb-0" style="font-size: 11px;">
#!/bin/bash
# Save as check_ips.sh, then: chmod +x check_ips.sh
# Usage: ./check_ips.sh suspicious_ips.txt

echo "IP Investigation Tool"
echo "====================="

while read ip; do
    echo -e "\n\033[1;36m=== Investigating: $ip ===\033[0m"
    
    # WHOIS
    echo "WHOIS Info:"
    whois $ip | grep -E "(inetnum|netname|descr|country|organisation|abuse)" | head -10
    
    # Ping check
    echo -n "Ping: "
    ping -c 1 -W 1 $ip >/dev/null 2>&1 && echo " Online" || echo " Offline (VPN/Proxy)"
    
    # Quick geolocation
    echo -n "Location: "
    curl -s "http://ip-api.com/line/$ip?fields=country,city,isp" | paste -s -d ','
    
    echo "--------------------------------"
done < "${1:-/dev/stdin}"</pre>
                                    <div class="mt-3">
                                        <button class="btn btn-sm btn-outline-light copy-btn" data-code='#!/bin/bash
# Save as check_ips.sh, then: chmod +x check_ips.sh
# Usage: ./check_ips.sh suspicious_ips.txt

echo "IP Investigation Tool"
echo "====================="

while read ip; do
    echo -e "\n\033[1;36m=== Investigating: $ip ===\033[0m"
    
    # WHOIS
    echo "WHOIS Info:"
    whois $ip | grep -E "(inetnum|netname|descr|country|organisation|abuse)" | head -10
    
    # Ping check
    echo -n "Ping: "
    ping -c 1 -W 1 $ip >/dev/null 2>&1 && echo " Online" || echo " Offline (VPN/Proxy)"
    
    # Quick geolocation
    echo -n "Location: "
    curl -s "http://ip-api.com/line/$ip?fields=country,city,isp" | paste -s -d ','
    
    echo "--------------------------------"
done < "${1:-/dev/stdin}"'>
                                            <i class="bi bi-clipboard me-1"></i> Copy Script
                                        </button>
                                        <small class="text-muted ms-2">Paste IPs from CSV column into a text file</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Why We Track Session IPs -->
                        <h5 class="text-info mt-4">
                            <i class="bi bi-shield-check me-2"></i>Why We Track Session IPs
                        </h5>
                        
                        <div class="row mt-3">
                            <div class="col-md-6 mb-3">
                                <div class="card border-info h-100">
                                    <div class="card-body">
                                        <h6 class="card-title text-info">
                                            <i class="bi bi-person-check me-2"></i>Prevent Fake Submissions
                                        </h6>
                                        <p class="card-text">
                                            Identifies multiple submissions from the same device to prevent:
                                             Fake data injection
                                             Bot spam attacks
                                             Duplicate registrations
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <div class="card border-info h-100">
                                    <div class="card-body">
                                        <h6 class="card-title text-info">
                                            <i class="bi bi-graph-up me-2"></i>Analytics & Insights
                                        </h6>
                                        <p class="card-text">
                                            Helps organizers understand:
                                             Geographic distribution
                                             Submission patterns
                                             Peak submission times
                                             Unique vs. repeat participants
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Common Issues Prevented -->
                        <h5 class="text-info mt-4">
                            <i class="bi bi-exclamation-triangle me-2"></i>Common Issues Prevented
                        </h5>
                        
                        <div class="table-responsive mt-3">
                            <table class="table table-sm table-bordered">
                                <thead class="table-info">
                                    <tr>
                                        <th width="30%">Issue</th>
                                        <th>How IP Tracking Helps</th>
                                        <th>Example</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="fw-semibold">Fake Data Injection</td>
                                        <td>Identifies multiple submissions from same device</td>
                                        <td>
                                            <span class="badge bg-danger">Blocked</span>
                                            Same person submitting 50 fake registrations
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Bot Attacks</td>
                                        <td>Detects automated submission patterns</td>
                                        <td>
                                            <span class="badge bg-danger">Blocked</span>
                                            Bot trying to spam form with gibberish data
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Duplicate Registrations</td>
                                        <td>Flags same person registering multiple times</td>
                                        <td>
                                            <span class="badge bg-warning">Flagged</span>
                                            Student trying to register 3 times for same event
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Geographic Verification</td>
                                        <td>Validates submissions are from expected regions</td>
                                        <td>
                                            <span class="badge bg-success">Verified</span>
                                            Local student vs. international spammer
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Privacy & Data Protection -->
                        <h5 class="text-info mt-4">
                            <i class="bi bi-eye me-2"></i>Privacy & Data Protection
                        </h5>
                        <div class="alert alert-light border-info">
                            <i class="bi bi-lock me-2"></i>
                            <strong>Your Privacy is Protected:</strong>
                            <ul class="mb-0 mt-2">
                                <li>IP addresses are stored securely and encrypted</li>
                                <li>Only form administrators can view IP data</li>
                                <li>IP data is never shared with third parties</li>
                                <li>Used solely for form security and verification</li>
                                <li>Cannot be used to identify individuals personally</li>
                            </ul>
                        </div>
                        
                        <!-- What IP Can/Can't Do -->
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="bi bi-check-circle text-success me-2"></i>What IP tracking CAN do
                                        </h6>
                                        <ul class="small mb-0">
                                            <li>Prevent form spam and abuse</li>
                                            <li>Ensure fair participation limits</li>
                                            <li>Detect suspicious activity patterns</li>
                                            <li>Verify submission authenticity</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="bi bi-x-circle text-danger me-2"></i>What IP tracking CANNOT do
                                        </h6>
                                        <ul class="small mb-0">
                                            <li>Identify you personally</li>
                                            <li>Track your browsing history</li>
                                            <li>Access your device information</li>
                                            <li>Monitor your other online activities</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tools for Investigation -->
                        <div class="mt-4 p-3 bg-info bg-opacity-10 border border-info rounded">
                            <h6 class="text-info">
                                <i class="bi bi-tools me-2"></i>GUI Tools for Non-Technical Users
                            </h6>
                            <p class="mb-2">
                                <strong>Prefer click-and-check tools?</strong> Use these:
                            </p>
                            <ul class="mb-0">
                                <li><strong>IP Lookup:</strong> <a href="https://whatismyipaddress.com/ip-lookup" target="_blank">WhatIsMyIPAddress.com</a></li>
                                <li><strong>WHOIS Lookup:</strong> <a href="https://whois.domaintools.com/" target="_blank">DomainTools WHOIS</a></li>
                                <li><strong>VPN Detection:</strong> <a href="https://ipleak.net/" target="_blank">IPLeak.net</a></li>
                                <li><strong>Tor Check:</strong> <a href="https://check.torproject.org/" target="_blank">Tor Project Check</a></li>
                                <li><strong>AbuseIPDB:</strong> <a href="https://www.abuseipdb.com/" target="_blank">Check IP reputation</a></li>
                            </ul>
                            <div class="alert alert-light small mt-2 mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Copy IP addresses from your CSV export and paste into these tools
                            </div>
                        </div>
                        
                        <!-- Real-World Example -->
                        <div class="mt-4 p-3 bg-warning bg-opacity-10 border border-warning rounded">
                            <h6 class="text-warning">
                                <i class="bi bi-chat-quote me-2"></i>Real-World Example for Form Creators
                            </h6>
                            <p class="mb-0">
                                <strong>Scenario:</strong> You notice 15 submissions from <code>54.240.197.215</code> (Amazon AWS) 
                                within 2 minutes. All have similar email patterns (<code>userXX@gmail.com</code>) and gibberish names. 
                                <strong>Action:</strong> These are likely fake submissions from a bot farm. You can safely delete 
                                these responses and consider enabling additional form security measures.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-info" onclick="window.print()">
                    <i class="bi bi-printer me-2"></i>Print This Guide
                </button>
                <button type="button" class="btn btn-warning" onclick="window.location.href='{{ url_for('download_csv_with_ip', event_id=event.id, form_id=form.id) }}'">
                    <i class="bi bi-download me-2"></i>Export CSV with IP
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Add copy functionality for bash commands

</script>

<style>
.table-modern {
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #e9ecef;
}

.table-modern th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    color: #495057;
    padding: 12px 16px;
}

.table-modern td {
    padding: 12px 16px;
    vertical-align: middle;
    border-top: 1px solid #e9ecef;
}

.table-modern tbody tr:hover {
    background-color: #f8f9fa;
}

.modal-content {
    border-radius: 10px;
    border: none;
}

.modal-header {
    background: linear-gradient(135deg, #4361ee 0%, #3f37c9 100%);
    color: white;
    border-radius: 10px 10px 0 0;
}

.modal-header .btn-close {
    filter: invert(1);
}

#bulkActions {
    transition: all 0.3s ease;
}

.verification-result {
    border-left: 4px solid #0dcaf0;
    padding-left: 15px;
    margin-bottom: 15px;
}

.verification-result.success {
    border-left-color: #198754;
}

.id-match {
    background-color: #d1fae5;
    border-radius: 4px;
    padding: 2px 6px;
    font-family: monospace;
}

#alertContainer .alert {
    min-width: 300px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.form-check-input:checked {
    background-color: #4361ee;
    border-color: #4361ee;
}

#volunteerModeStatus.text-success {
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.refreshing {
    animation: pulse 2s infinite;
}

#volunteerCount.refreshing,
#totalAccesses.refreshing,
#lastAccess.refreshing {
    color: #4361ee;
}
/* Add to your existing styles */
.btn-outline-warning {
    color: #f59e0b;
    border-color: #f59e0b;
}

.btn-outline-warning:hover {
    background-color: #f59e0b;
    border-color: #f59e0b;
    color: white;
}

.modal-footer .btn-warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    border: none;
    color: white;
}

.modal-footer .btn-warning:hover {
    background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
}
</style>


<script src="{{ url_for('static', filename='js/qrcode.min.js') }}"></script>
<!-- Add html2pdf library for client-side PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" 
        integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" 
        crossorigin="anonymous" 
        referrerpolicy="no-referrer"></script>
<script>
// Brand configuration
const BRAND_LOGO_URL = '/static/logo/icon.png';
const BRAND_NAME = 'EventFlow';
const BRAND_SLOGAN = 'Professional Event Management Solution';

// ===== SEARCH FUNCTIONS =====
function searchVerification() {
    const searchInput = document.getElementById('verificationSearch');
    const searchTerm = searchInput.value.trim();
    
    if (!searchTerm) {
        showAlert('Please enter a Response ID or Verification ID', 'warning');
        return;
    }
    
    const searchResults = document.getElementById('searchResults');
    const resultContent = document.getElementById('searchResultContent');
    
    showLoading('Searching for verification...');
    
    resultContent.innerHTML = '';
    searchResults.style.display = 'none';
    
    setTimeout(() => {
        hideLoading();
        
        const foundResponses = [];
        const responseElements = document.querySelectorAll('.response-id-display');
        
        responseElements.forEach((element, index) => {
            const responseId = element.getAttribute('data-id') || '';
            const entryNumber = index + 1;
            const row = element.closest('tr');
            const timestamp = row ? row.querySelector('td:nth-child(3) small').textContent.trim() : '';
            const formIdShort = '{{ form.id[:8] }}';
            
            const verificationId = `VER-${formIdShort}-${entryNumber}-${responseId.substring(0, 8)}`;
            
            if (responseId.includes(searchTerm) || 
                verificationId.includes(searchTerm) ||
                responseId.toLowerCase().includes(searchTerm.toLowerCase()) ||
                verificationId.toLowerCase().includes(searchTerm.toLowerCase())) {
                
                foundResponses.push({
                    responseId: responseId,
                    verificationId: verificationId,
                    entryNumber: entryNumber,
                    timestamp: timestamp
                });
            }
        });
        
        if (foundResponses.length > 0) {
            searchResults.style.display = 'block';
            
            foundResponses.forEach((result, index) => {
                const resultDiv = document.createElement('div');
                resultDiv.className = `verification-result ${index === 0 ? 'success' : ''}`;
                
                resultDiv.innerHTML = `
                    <h6 class="mb-2">
                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                        Match Found #${index + 1}
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Response ID:</strong> <span class="id-match">${result.responseId}</span></p>
                            <p class="mb-1"><strong>Verification ID:</strong> <code>${result.verificationId}</code></p>
                            <p class="mb-1"><strong>Entry #:</strong> ${result.entryNumber}</p>
                            <p class="mb-1"><strong>Submitted:</strong> ${result.timestamp || 'N/A'}</p>
                        </div>
                        <div class="col-md-6">
                            <div class="d-grid gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="openResponseModal(${result.entryNumber})">
                                    <i class="bi bi-eye"></i> View Details
                                </button>
                                <a href="/verify_response/{{ event.id }}/{{ form.id }}/${result.responseId}" 
                                   class="btn btn-sm btn-outline-success" target="_blank">
                                    <i class="bi bi-qr-code-scan"></i> Verify Online
                                </a>
                                <button class="btn btn-sm btn-outline-info" onclick="copyToSearch('${result.responseId}')">
                                    <i class="bi bi-clipboard"></i> Copy ID
                                </button>
                            </div>
                        </div>
                    </div>
                    ${index < foundResponses.length - 1 ? '<hr class="my-3">' : ''}
                `;
                
                resultContent.appendChild(resultDiv);
            });
            
            searchResults.scrollIntoView({ behavior: 'smooth' });
            
        } else {
            showAlert(`No matches found for "${searchTerm}". Try searching by Response ID or Verification ID.`, 'danger');
        }
    }, 1000);
}

// At the top of your JavaScript, add:
window.addEventListener('error', function(e) {
    if (e.target && e.target.tagName === 'SCRIPT' && 
        (e.target.src.includes('qrcode') || e.target.src.includes('qrcode'))) {
        console.warn('QR Code library failed to load, but server-side generation will still work');
        // Prevent the error from showing in console
        e.preventDefault();
    }
}, true);

function showRecentVerifications() {
    const searchResults = document.getElementById('searchResults');
    const resultContent = document.getElementById('searchResultContent');
    
    showLoading('Loading recent verifications...');
    
    resultContent.innerHTML = '';
    searchResults.style.display = 'none';
    
    setTimeout(() => {
        hideLoading();
        
        const recentResponses = [];
        const responseElements = document.querySelectorAll('.response-id-display');
        const totalResponses = responseElements.length;
        
        const startIndex = Math.max(0, totalResponses - 5);
        
        responseElements.forEach((element, index) => {
            if (index >= startIndex) {
                const responseId = element.getAttribute('data-id') || '';
                const entryNumber = index + 1;
                const row = element.closest('tr');
                const timestamp = row ? row.querySelector('td:nth-child(3) small').textContent.trim() : '';
                const formIdShort = '{{ form.id[:8] }}';
                
                recentResponses.push({
                    responseId: responseId,
                    verificationId: `VER-${formIdShort}-${entryNumber}-${responseId.substring(0, 8)}`,
                    entryNumber: entryNumber,
                    timestamp: timestamp
                });
            }
        });
        
        if (recentResponses.length > 0) {
            searchResults.style.display = 'block';
            
            resultContent.innerHTML = `
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    Showing ${recentResponses.length} most recent verified responses
                </div>
            `;
            
            recentResponses.reverse().forEach((result, index) => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'verification-result';
                
                resultDiv.innerHTML = `
                    <h6 class="mb-2">
                        <i class="bi bi-clock-history me-2"></i>
                        Recent Verification #${index + 1}
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Response ID:</strong> <span class="id-match">${result.responseId}</span></p>
                            <p class="mb-1"><strong>Verification ID:</strong> <code>${result.verificationId}</code></p>
                            <p class="mb-1"><strong>Entry #:</strong> ${result.entryNumber}</p>
                            <p class="mb-1"><strong>Submitted:</strong> ${result.timestamp || 'N/A'}</p>
                        </div>
                        <div class="col-md-6">
                            <div class="d-grid gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="openResponseModal(${result.entryNumber})">
                                    <i class="bi bi-eye"></i> View Details
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="copyToSearch('${result.responseId}')">
                                    <i class="bi bi-search"></i> Search This
                                </button>
                            </div>
                        </div>
                    </div>
                    ${index < recentResponses.length - 1 ? '<hr class="my-3">' : ''}
                `;
                
                resultContent.appendChild(resultDiv);
            });
            
            searchResults.scrollIntoView({ behavior: 'smooth' });
            
        } else {
            showAlert('No recent verifications found.', 'info');
        }
    }, 800);
}

function getSubmissionDate(timestamp) {
    if (!timestamp) return 'N/A';
    
    try {
        const date = new Date(timestamp);
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        return date.toLocaleDateString('en-US', options);
    } catch (e) {
        return 'N/A';
    }
}

function copyToSearch(id) {
    const searchInput = document.getElementById('verificationSearch');
    searchInput.value = id;
    searchInput.focus();
    
    setTimeout(() => {
        searchVerification();
    }, 300);
}

function openResponseModal(entryNumber) {
    const modalId = `responseDetailModal${entryNumber}`;
    const modalElement = document.getElementById(modalId);
    
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    } else {
        showAlert(`Could not find details for entry #${entryNumber}`, 'warning');
    }
}

// ===== VOLUNTEER MODE MANAGEMENT =====
let currentVolunteerCode = null;
let volunteerRefreshInterval = null;
let sessionCheckInterval = null;
let volunteerModeEnabled = false;

function toggleVolunteerMode() {
    const toggle = document.getElementById('volunteerModeToggle');
    const content = document.getElementById('volunteerModeContent');
    const status = document.getElementById('volunteerModeStatus');
    
    if (toggle.checked) {
        // Enable volunteer mode - this creates the status file with enabled: true
        generateVolunteerCode();
        
        // Update UI
        content.style.display = 'block';
        status.textContent = 'Enabled';
        status.classList.remove('text-muted');
        status.classList.add('text-success');
        volunteerModeEnabled = true;
        
        showAlert('Volunteer mode enabled! Volunteers can now access the verification system.', 'success');
    } else {
        // Disable volunteer mode - this sets enabled: false in status file
        fetch(`/disable_volunteer_mode/{{ event.id }}/{{ form.id }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update UI
                content.style.display = 'none';
                status.textContent = 'Disabled';
                status.classList.remove('text-success');
                status.classList.add('text-muted');
                volunteerModeEnabled = false;
                
                showAlert('Volunteer mode disabled. All active volunteer sessions have been terminated.', 'warning');
            }
        })
        .catch(error => {
            // Revert toggle on error
            toggle.checked = true;
            showAlert('Error disabling volunteer mode: ' + error.message, 'danger');
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.copy-btn').forEach(button => {
        button.addEventListener('click', function() {
            const code = this.getAttribute('data-code');
            navigator.clipboard.writeText(code).then(() => {
                const originalHTML = this.innerHTML;
                this.innerHTML = '<i class="bi bi-check"></i> Copied!';
                this.classList.add('btn-success');
                this.classList.remove('btn-outline-light');
                
                setTimeout(() => {
                    this.innerHTML = originalHTML;
                    this.classList.remove('btn-success');
                    this.classList.add('btn-outline-light');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy. Please copy manually.');
            });
        });
    });
});

// ===== DOWNLOAD AS PDF FUNCTION (USES PRINT FUNCTION DESIGN) =====
async function downloadResponseAsPDF(responseId, responseNumber) {
    console.log('Downloading PDF for response:', responseId, '#', responseNumber);
    
    // Get modal reference
    const modalId = `responseDetailModal${responseNumber}`;
    const modalElement = document.getElementById(modalId);
    
    if (!modalElement) {
        showAlert('Cannot find response details. Please try again.', 'warning');
        return;
    }

    const qrCodeData = modalElement.querySelector('.qr-code-data')?.value || '';
    
    if (!qrCodeData) {
        if (!confirm('QR code data not found. Download PDF without QR code verification?')) {
            return;
        }
    }

    showLoading('Generating PDF...');
    
    try {
        // Use the EXACT SAME HTML generation as print function
        const printHTML = generatePrintHTMLForPDF(modalElement, responseNumber, responseId, qrCodeData);
        
        // Create filename
        const formTitle = '{{ form.title if form.title else "Form" }}';
        const eventName = '{{ event.name if event.name else "Event" }}';
        const safeFormTitle = formTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        const safeEventName = eventName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        const filename = `${safeEventName}_${safeFormTitle}_response_${responseNumber}_${responseId.substring(0, 8)}.pdf`;
        
        // Use html2pdf.js with print function's HTML
        const opt = {
            margin:       0.5,
            filename:     filename,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { 
                scale: 2, 
                useCORS: true,
                logging: false,
                letterRendering: true,
                backgroundColor: '#ffffff',
                onclone: function(clonedDoc) {
                    // Remove any print-specific scripts
                    const scripts = clonedDoc.querySelectorAll('script');
                    scripts.forEach(script => script.remove());
                }
            },
            jsPDF:        { 
                unit: 'in', 
                format: 'letter', 
                orientation: 'portrait',
                compress: true
            }
        };
        
        // Generate and download PDF
        await html2pdf().set(opt).from(printHTML).save();
        
        hideLoading();
        showAlert('PDF downloaded successfully!', 'success');
        
    } catch (error) {
        hideLoading();
        console.error('PDF download error:', error);
        
        // Fallback: Use print dialog
        if (confirm('PDF generation failed. Would you like to print instead?')) {
            printResponse(modalId, responseNumber);
        }
    }
}

/// ===== SIMPLIFIED DOWNLOAD AS PDF FUNCTION =====
async function downloadResponseAsPDF(responseId, responseNumber) {
    console.log('Downloading PDF for response:', responseId, '#', responseNumber);
    
    showLoading('Generating PDF...');
    
    try {
        // DIRECT SOLUTION: Call the print function to get its HTML
        const printHTML = getPrintHTML(responseId, responseNumber);
        
        if (!printHTML) {
            throw new Error('Could not generate PDF content');
        }
        
        // Create filename
        const formTitle = '{{ form.title if form.title else "Form" }}';
        const eventName = '{{ event.name if event.name else "Event" }}';
        const safeFormTitle = formTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        const safeEventName = eventName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        const filename = `${safeEventName}_${safeFormTitle}_response_${responseNumber}_${responseId.substring(0, 8)}.pdf`;
        
        // Use html2pdf.js with the print function's HTML
        const opt = {
            margin:       0.5,
            filename:     filename,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { 
                scale: 2, 
                useCORS: true,
                logging: false,
                letterRendering: true,
                backgroundColor: '#ffffff'
            },
            jsPDF:        { 
                unit: 'in', 
                format: 'letter', 
                orientation: 'portrait',
                compress: true
            }
        };
        
        // Generate and download PDF
        await html2pdf().set(opt).from(printHTML).save();
        
        hideLoading();
        showAlert('PDF downloaded successfully!', 'success');
        
    } catch (error) {
        hideLoading();
        console.error('PDF download error:', error);
        showAlert('Error downloading PDF: ' + error.message, 'danger');
        
        // Fallback: Use print dialog
        if (confirm('PDF generation failed. Would you like to print instead?')) {
            const modalId = `responseDetailModal${responseNumber}`;
            printResponse(modalId, responseNumber);
        }
    }
}

// ===== DOWNLOAD AS PDF FUNCTION (EXACT COPY OF PRINT FUNCTION) =====
async function downloadResponseAsPDF(responseId, responseNumber) {
    console.log('Downloading PDF for response:', responseId, '#', responseNumber);
    
    // Get modal reference
    const modalId = `responseDetailModal${responseNumber}`;
    const modalElement = document.getElementById(modalId);
    
    if (!modalElement) {
        showAlert('Cannot find response details. Please try again.', 'warning');
        return;
    }

    const qrCodeData = modalElement.querySelector('.qr-code-data')?.value || '';
    const verificationUrl = modalElement.querySelector('.verification-url')?.value || '';
    const responseIdElement = modalElement.querySelector('.response-id')?.value || responseId;
    
    console.log('QR Code Data:', qrCodeData ? 'Present' : 'Missing');
    
    if (!qrCodeData) {
        if (!confirm('QR code data not found. Download PDF without QR code verification?')) {
            return;
        }
    }

    showLoading('Generating PDF...');
    
    try {
        // USE THE EXACT SAME HTML GENERATION AS PRINT FUNCTION
        const printHTML = generateExactPrintHTML(modalElement, responseNumber, responseIdElement, qrCodeData);
        
        // Create filename
        const formTitle = '{{ form.title if form.title else "Form" }}';
        const eventName = '{{ event.name if event.name else "Event" }}';
        const safeFormTitle = formTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        const safeEventName = eventName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        const filename = `${safeEventName}_${safeFormTitle}_response_${responseNumber}_${responseId.substring(0, 8)}.pdf`;
        
        // Use html2pdf.js with the exact same HTML
        const opt = {
            margin:       0.5,
            filename:     filename,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { 
                scale: 2, 
                useCORS: true,
                logging: false,
                letterRendering: true,
                backgroundColor: '#ffffff'
            },
            jsPDF:        { 
                unit: 'in', 
                format: 'letter', 
                orientation: 'portrait',
                compress: true
            }
        };
        
        // Generate and download PDF
        await html2pdf().set(opt).from(printHTML).save();
        
        hideLoading();
        showAlert('PDF downloaded successfully!', 'success');
        
    } catch (error) {
        hideLoading();
        console.error('PDF download error:', error);
        showAlert('Error downloading PDF: ' + error.message, 'danger');
        
        // Fallback: Use print dialog
        if (confirm('PDF generation failed. Would you like to print instead?')) {
            printResponse(modalId, responseNumber);
        }
    }
}



function saveVolunteerModeState(enabled) {
    localStorage.setItem(`volunteerModeEnabled_{{ event.id }}_{{ form.id }}`, enabled);
    
    if (enabled && currentVolunteerCode) {
        localStorage.setItem(`volunteerCode_{{ event.id }}_{{ form.id }}`, currentVolunteerCode);
    }
}

function clearVolunteerData() {
    localStorage.removeItem(`volunteerModeEnabled_{{ event.id }}_{{ form.id }}`);
    localStorage.removeItem(`volunteerCode_{{ event.id }}_{{ form.id }}`);
    localStorage.removeItem(`volunteerLink_{{ event.id }}_{{ form.id }}`);
}

function resetVolunteerCodeDisplay() {
    const codeDisplay = document.getElementById('volunteerCodeDisplay');
    const linkInput = document.getElementById('volunteerLink');
    
    if (codeDisplay) codeDisplay.textContent = '-------- --------';
    if (linkInput) linkInput.value = '';
    
    // Disable copy buttons
    const copyCodeBtn = document.getElementById('copyCodeBtn');
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    if (copyCodeBtn) copyCodeBtn.disabled = true;
    if (copyLinkBtn) copyLinkBtn.disabled = true;
    
    // Hide active volunteers section
    const activeSection = document.getElementById('activeVolunteersSection');
    if (activeSection) activeSection.style.display = 'none';
}

function generateVolunteerCode() {
    showLoading('Generating volunteer access code...');
    
    fetch('/volunteer_access/{{ event.id }}/{{ form.id }}')
    .then(response => response.json())
    .then(data => {
        hideLoading();
        
        if (data.success) {
            currentVolunteerCode = data.code;
            
            // Display the code with formatting
            const codeDisplay = document.getElementById('volunteerCodeDisplay');
            const formattedCode = data.code.replace(/(.{8})/g, '$1 ').trim();
            if (codeDisplay) codeDisplay.textContent = formattedCode;
            
            // Update the access link
            const linkInput = document.getElementById('volunteerLink');
            if (linkInput) linkInput.value = data.access_url;
            
            // Enable copy buttons
            const copyCodeBtn = document.getElementById('copyCodeBtn');
            const copyLinkBtn = document.getElementById('copyLinkBtn');
            if (copyCodeBtn) copyCodeBtn.disabled = false;
            if (copyLinkBtn) copyLinkBtn.disabled = false;
            
            // Save to localStorage
            localStorage.setItem(`volunteerCode_{{ event.id }}_{{ form.id }}`, currentVolunteerCode);
            localStorage.setItem(`volunteerLink_{{ event.id }}_{{ form.id }}`, data.access_url);
            localStorage.setItem(`volunteerModeEnabled_{{ event.id }}_{{ form.id }}`, 'true');
            
            // Load active volunteers
            loadActiveVolunteers();
            
            showAlert('Volunteer access code generated successfully!', 'success');
        } else {
            showAlert('Error generating code: ' + data.error, 'danger');
            resetVolunteerModeOnError();
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('Error generating code: ' + error.message, 'danger');
        resetVolunteerModeOnError();
    });
}

function resetVolunteerModeOnError() {
    const toggle = document.getElementById('volunteerModeToggle');
    if (toggle) {
        toggle.checked = false;
        toggleVolunteerMode();
    }
}

function generateNewCode() {
    if (confirm('Generate a new volunteer code? The old code will be invalidated and all active volunteer sessions will be terminated.')) {
        // First notify volunteers about code change
        notifyVolunteersSessionEnded('The volunteer access code has been changed. Please request a new code from the administrator.');
        
        // Then generate new code
        generateVolunteerCode();
    }
}

function copyVolunteerCode() {
    if (!currentVolunteerCode) return;
    
    navigator.clipboard.writeText(currentVolunteerCode).then(() => {
        showAlert('Volunteer code copied to clipboard!', 'success');
    }).catch(err => {
        alert('Failed to copy code. Please copy manually: ' + currentVolunteerCode);
    });
}

function copyVolunteerLink() {
    const linkInput = document.getElementById('volunteerLink');
    
    if (!linkInput || !linkInput.value) return;
    
    linkInput.select();
    linkInput.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(linkInput.value).then(() => {
        showAlert('Volunteer link copied to clipboard!', 'success');
    }).catch(err => {
        alert('Failed to copy link. Please copy manually: ' + linkInput.value);
    });
}

// ===== VOLUNTEER LIST MANAGEMENT =====
// In your view_form.html JavaScript, update the loadActiveVolunteers function:

function loadActiveVolunteers() {
    if (!volunteerModeEnabled) return;
    
    // Add refreshing animation
    const stats = document.querySelectorAll('#volunteerCount, #totalAccesses, #lastAccess');
    stats.forEach(stat => stat.classList.add('refreshing'));
    
    fetch('/get_active_volunteers/{{ event.id }}/{{ form.id }}')
    .then(response => response.json())
    .then(data => {
        // Remove refreshing animation
        stats.forEach(stat => stat.classList.remove('refreshing'));
        
        console.log('Volunteers response:', data);  // Debug log
        
        if (data.success) {
            // FIX: Check if volunteers exists
            const volunteers = data.volunteers || [];
            const stats = data.stats || { active_count: 0, total_accesses: 0, last_access: null };
            
            displayVolunteers(volunteers);
            updateVolunteerStats(stats);
        } else {
            console.error('Failed to load volunteers:', data.error);
            // Display empty list on error
            displayVolunteers([]);
            updateVolunteerStats({ active_count: 0, total_accesses: 0, last_access: null });
        }
    })
    .catch(error => {
        console.error('Error loading volunteers:', error);
        // Remove refreshing animation even on error
        stats.forEach(stat => stat.classList.remove('refreshing'));
        // Display empty list on network error
        displayVolunteers([]);
        updateVolunteerStats({ active_count: 0, total_accesses: 0, last_access: null });
    });
}
function displayVolunteers(volunteers) {
    const volunteersList = document.getElementById('volunteersList');
    const activeSection = document.getElementById('activeVolunteersSection');
    
    if (!volunteersList || !activeSection) return;
    
    // FIX: Always ensure volunteers is an array
    if (!Array.isArray(volunteers)) {
        volunteers = [];
    }
    
    if (volunteers.length === 0) {
        activeSection.style.display = 'none';
        volunteersList.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-3">
                    <i class="bi bi-people"></i> No active volunteers
                </td>
            </tr>
        `;
        return;
    }
    
    activeSection.style.display = 'block';
    
    let html = '';
    volunteers.forEach(volunteer => {
        // FIX: Add null checks for all properties
        const created = volunteer.created_at ? new Date(volunteer.created_at) : new Date();
        const lastAccess = volunteer.last_access ? new Date(volunteer.last_access) : null;
        const expires = volunteer.expires_at ? new Date(volunteer.expires_at) : new Date();
        const isExpired = new Date() > expires;
        const now = new Date();
        const timeRemaining = Math.max(0, Math.floor((expires - now) / (1000 * 60 * 60)));
        
        html += `
            <tr class="${isExpired ? 'table-secondary' : ''}">
                <td>
                    <strong>${volunteer.volunteer_name || 'Not logged in'}</strong>
                    ${isExpired ? 
                        '<span class="badge bg-warning ms-1">Expired</span>' : 
                        `<span class="badge bg-success ms-1">Active (${timeRemaining}h)</span>`
                    }
                </td>
                <td><code class="small">${volunteer.code || 'Unknown'}</code></td>
                <td>${created.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                <td>
                    ${lastAccess ? 
                        lastAccess.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 
                        '<span class="text-muted">Never</span>'
                    }
                </td>
                <td>
                    <span class="badge bg-info">${volunteer.access_count || 0}</span>
                </td>
                <td>
                    ${isExpired ? 
                        '<span class="badge bg-warning">Expired</span>' : 
                        '<span class="badge bg-success">Active</span>'
                    }
                </td>
            </tr>
        `;
    });
    
    volunteersList.innerHTML = html;
}

function updateVolunteerStats(stats) {
    const volunteerCount = document.getElementById('volunteerCount');
    const totalAccesses = document.getElementById('totalAccesses');
    const lastAccess = document.getElementById('lastAccess');
    
    if (!volunteerCount || !totalAccesses || !lastAccess) return;
    
    volunteerCount.textContent = stats.active_count;
    totalAccesses.textContent = stats.total_accesses;
    
    if (stats.last_access) {
        const lastAccessTime = new Date(stats.last_access);
        lastAccess.textContent = lastAccessTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    } else {
        lastAccess.textContent = '--:--';
    }
}

// ===== AUTO-REFRESH FUNCTIONS =====
function startVolunteerRefresh() {
    // Stop any existing interval
    if (volunteerRefreshInterval) {
        clearInterval(volunteerRefreshInterval);
    }
    
    // Refresh volunteer list every 10 seconds
    volunteerRefreshInterval = setInterval(() => {
        if (volunteerModeEnabled) {
            console.log('Auto-refreshing volunteer list...');
            loadActiveVolunteers();
        }
    }, 10000); // 10 seconds
    
    console.log('Volunteer refresh started (10s interval)');
}

function stopVolunteerRefresh() {
    if (volunteerRefreshInterval) {
        clearInterval(volunteerRefreshInterval);
        volunteerRefreshInterval = null;
        console.log('Volunteer refresh stopped');
    }
}

// ===== SESSION CHECK FUNCTIONS =====
function startSessionCheck() {
    // Stop any existing interval
    if (sessionCheckInterval) {
        clearInterval(sessionCheckInterval);
    }
    
    // Check session every 30 seconds
    sessionCheckInterval = setInterval(() => {
        checkVolunteerSession();
    }, 30000); // 30 seconds
    
    // Also check when page becomes visible
    document.addEventListener('visibilitychange', handleVisibilityChange);
    
    console.log('Session check started (30s interval)');
}

function handleVisibilityChange() {
    if (!document.hidden && volunteerModeEnabled) {
        // Page became visible, check session
        checkVolunteerSession();
    }
}

function stopSessionCheck() {
    if (sessionCheckInterval) {
        clearInterval(sessionCheckInterval);
        sessionCheckInterval = null;
    }
    
    // Remove event listener
    document.removeEventListener('visibilitychange', handleVisibilityChange);
    
    console.log('Session check stopped');
}

function handleSessionEnded(message) {
    // Stop all services
    stopVolunteerRefresh();
    stopSessionCheck();
    
    // Reset UI
    const toggle = document.getElementById('volunteerModeToggle');
    if (toggle) toggle.checked = false;
    
    const content = document.getElementById('volunteerModeContent');
    if (content) content.style.display = 'none';
    
    const status = document.getElementById('volunteerModeStatus');
    if (status) {
        status.textContent = 'Disabled';
        status.classList.remove('text-success');
        status.classList.add('text-muted');
    }
    
    // Clear data
    currentVolunteerCode = null;
    volunteerModeEnabled = false;
    clearVolunteerData();
    resetVolunteerCodeDisplay();
    
    // Show alert
    showAlert(message || 'Volunteer session has ended.', 'warning');
}

// ===== NOTIFICATION FUNCTIONS =====
function notifyVolunteersSessionEnded(message = null) {
    fetch('/notify_volunteers_session_end/{{ event.id }}/{{ form.id }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message || 'Volunteer mode has been disabled by the administrator.',
            timestamp: new Date().toISOString(),
            admin: '{{ session.username }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Volunteers notified:', data);
    })
    .catch(error => {
        console.error('Notification error:', error);
    });
}

// ===== PAGE LOAD INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
    initializeVolunteerMode();
    setupEventListeners();
});

function initializeVolunteerMode() {
    const toggle = document.getElementById('volunteerModeToggle');
    
    if (!toggle) return;
    
    console.log('Initializing volunteer mode...');
    
    // First check server state
    checkServerVolunteerState().then(serverData => {
        console.log('Server volunteer state:', serverData);
        
        if (serverData.enabled) {
            // Server says volunteer mode is ENABLED
            toggle.checked = true;
            currentVolunteerCode = serverData.code;
            
            // Update UI
            const content = document.getElementById('volunteerModeContent');
            const status = document.getElementById('volunteerModeStatus');
            
            if (content) content.style.display = 'block';
            if (status) {
                status.textContent = 'Enabled';
                status.classList.remove('text-muted');
                status.classList.add('text-success');
            }
            
            volunteerModeEnabled = true;
            
            // Update code display
            const codeDisplay = document.getElementById('volunteerCodeDisplay');
            const linkInput = document.getElementById('volunteerLink');
            
            if (codeDisplay && serverData.code) {
                const formattedCode = serverData.code.replace(/(.{8})/g, '$1 ').trim();
                codeDisplay.textContent = formattedCode;
            }
            
            if (linkInput && serverData.code) {
                // Generate access URL
                const baseUrl = window.location.origin;
                const accessUrl = `${baseUrl}/volunteer_login/${serverData.code}`;
                linkInput.value = accessUrl;
                
                // Save to localStorage
                localStorage.setItem(`volunteerLink_{{ event.id }}_{{ form.id }}`, accessUrl);
            }
            
            // Enable copy buttons
            const copyCodeBtn = document.getElementById('copyCodeBtn');
            const copyLinkBtn = document.getElementById('copyLinkBtn');
            if (copyCodeBtn) copyCodeBtn.disabled = false;
            if (copyLinkBtn) copyLinkBtn.disabled = false;
            
            // Save to localStorage
            localStorage.setItem(`volunteerModeEnabled_{{ event.id }}_{{ form.id }}`, 'true');
            if (serverData.code) {
                localStorage.setItem(`volunteerCode_{{ event.id }}_{{ form.id }}`, serverData.code);
            }
            
            // Start services
            startVolunteerRefresh();
            
            // Load active volunteers
            loadActiveVolunteers();
            
            console.log('Volunteer mode initialized from server: ENABLED');
            
        } else {
            // Server says volunteer mode is DISABLED
            toggle.checked = false;
            volunteerModeEnabled = false;
            
            // Update UI
            const content = document.getElementById('volunteerModeContent');
            const status = document.getElementById('volunteerModeStatus');
            
            if (content) content.style.display = 'none';
            if (status) {
                status.textContent = 'Disabled';
                status.classList.remove('text-success');
                status.classList.add('text-muted');
            }
            
            console.log('Volunteer mode initialized from server: DISABLED');
        }
        
    }).catch(error => {
        console.error('Failed to check server state:', error);
        
        // Fallback to localStorage
        const savedEnabled = localStorage.getItem(`volunteerModeEnabled_{{ event.id }}_{{ form.id }}`) === 'true';
        const savedCode = localStorage.getItem(`volunteerCode_{{ event.id }}_{{ form.id }}`);
        
        if (savedEnabled && savedCode) {
            toggle.checked = true;
            currentVolunteerCode = savedCode;
            
            // Update UI
            const content = document.getElementById('volunteerModeContent');
            const status = document.getElementById('volunteerModeStatus');
            
            if (content) content.style.display = 'block';
            if (status) {
                status.textContent = 'Enabled';
                status.classList.remove('text-muted');
                status.classList.add('text-success');
            }
            
            volunteerModeEnabled = true;
            
            // Restore code display
            const codeDisplay = document.getElementById('volunteerCodeDisplay');
            const linkInput = document.getElementById('volunteerLink');
            
            if (codeDisplay && savedCode) {
                const formattedCode = savedCode.replace(/(.{8})/g, '$1 ').trim();
                codeDisplay.textContent = formattedCode;
            }
            
            if (linkInput) {
                const savedLink = localStorage.getItem(`volunteerLink_{{ event.id }}_{{ form.id }}`);
                if (savedLink) linkInput.value = savedLink;
            }
            
            // Enable copy buttons
            const copyCodeBtn = document.getElementById('copyCodeBtn');
            const copyLinkBtn = document.getElementById('copyLinkBtn');
            if (copyCodeBtn) copyCodeBtn.disabled = false;
            if (copyLinkBtn) copyLinkBtn.disabled = false;
            
            // Start services
            startVolunteerRefresh();
            
            showAlert('Unable to verify server state. Volunteer mode restored from cache.', 'warning');
            console.log('Volunteer mode restored from localStorage cache');
        } else {
            // No saved state, default to disabled
            toggle.checked = false;
            volunteerModeEnabled = false;
            console.log('Volunteer mode initialized: DISABLED (no saved state)');
        }
    });
}

async function checkServerVolunteerState() {
    try {
        const response = await fetch(`/check_volunteer_mode_status/{{ event.id }}/{{ form.id }}`);
        const data = await response.json();
        
        return {
            enabled: data.enabled || false,
            code: data.code || null,
            created_at: data.created_at || null,
            status: data.status || 'unknown'
        };
        
    } catch (error) {
        console.error('Check server state error:', error);
        throw error;
    }
}

function setupEventListeners() {
    const toggle = document.getElementById('volunteerModeToggle');
    const confirmDelete = document.getElementById('confirmDelete');
    const confirmDeleteAll = document.getElementById('confirmDeleteAll');
    
    if (toggle) {
        toggle.addEventListener('change', function() {
            localStorage.setItem('volunteerModeEnabled_{{ event.id }}_{{ form.id }}', this.checked);
        });
    }
    
    if (confirmDelete) {
        confirmDelete.addEventListener('change', function() {
            const deleteButton = document.getElementById('deleteFormButton');
            if (deleteButton) {
                deleteButton.disabled = !this.checked;
            }
        });
    }
    
    if (confirmDeleteAll) {
        confirmDeleteAll.addEventListener('change', function() {
            const deleteAllButton = document.getElementById('deleteAllResponsesButton');
            if (deleteAllButton) {
                deleteAllButton.disabled = !this.checked;
            }
        });
    }
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        stopVolunteerRefresh();
        stopSessionCheck();
    });
}

// ===== ADD SESSION ENDED MODAL STYLES =====
function addSessionEndedModalStyles() {
    if (!document.getElementById('sessionEndedModalStyles')) {
        const style = document.createElement('style');
        style.id = 'sessionEndedModalStyles';
        style.textContent = `
            .session-ended-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
                z-index: 99999;
                display: none;
                align-items: center;
                justify-content: center;
            }
            
            .session-ended-content {
                background: white;
                padding: 50px;
                border-radius: 20px;
                text-align: center;
                max-width: 500px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                animation: fadeInUp 0.5s ease-out;
            }
            
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            .session-ended-icon {
                font-size: 80px;
                color: #4361ee;
                margin-bottom: 20px;
            }
            
            .session-ended-title {
                font-size: 32px;
                font-weight: 700;
                margin-bottom: 15px;
                background: linear-gradient(135deg, #4361ee 0%, #7209b7 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }
            
            .session-ended-message {
                font-size: 18px;
                color: #666;
                margin-bottom: 30px;
                line-height: 1.6;
            }
            
            .session-ended-button {
                background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
                color: white;
                border: none;
                padding: 15px 40px;
                border-radius: 50px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 10px 30px rgba(67, 97, 238, 0.3);
            }
            
            .session-ended-button:hover {
                transform: translateY(-3px);
                box-shadow: 0 15px 40px rgba(67, 97, 238, 0.4);
            }
        `;
        document.head.appendChild(style);
    }
}

// Initialize styles
addSessionEndedModalStyles();

// ===== PRINT RESPONSE FUNCTION =====
function printResponse(modalId, responseNumber) {
    console.log('Print function called for:', modalId, 'Response #:', responseNumber);
    
    const modalElement = document.getElementById(modalId);
    if (!modalElement) {
        console.error('Modal not found:', modalId);
        alert('Cannot find the response details. Please try again.');
        return;
    }

    const qrCodeData = modalElement.querySelector('.qr-code-data')?.value || '';
    const verificationUrl = modalElement.querySelector('.verification-url')?.value || '';
    const responseId = modalElement.querySelector('.response-id')?.value || '';
    
    console.log('QR Code Data:', qrCodeData ? 'Present' : 'Missing');
    
    if (!qrCodeData) {
        if (!confirm('QR code data not found. Print without QR code verification?')) {
            return;
        }
    }

    const currentDate = new Date();
    const formattedDate = currentDate.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });

    let responseData = '';
    const table = modalElement.querySelector('.modal-body .table-responsive');
    if (table) {
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(function(row) {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 2) {
                const question = cells[0].textContent.trim() || 'Question';
                let answer = '';
                
                if (cells[1].querySelector('.text-decoration-none')) {
                    const fileLink = cells[1].querySelector('.text-decoration-none');
                    const fileName = fileLink.textContent.trim() || 'File';
                    answer = `
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin: 8px 0; border-left: 4px solid #4361ee;">
                            <div style="font-weight: 600; color: #4361ee; display: flex; align-items: center; gap: 8px;">
                                <i class="bi bi-paperclip"></i> ${escapeHtml(fileName)}
                            </div>
                            <div style="font-size: 10pt; color: #666; margin-top: 4px;">
                                File uploaded - See original system for access
                            </div>
                        </div>
                    `;
                } else {
                    const answerText = cells[1].textContent.trim();
                    if (answerText) {
                        answer = `<div style="padding: 10px 0;">${escapeHtml(answerText)}</div>`;
                    } else {
                        answer = '<span style="color: #999; font-style: italic;">Not provided</span>';
                    }
                }
                
                responseData += `
                    <tr>
                        <td style="width: 35%; font-weight: 600; color: #2c3e50; border-right: 2px solid #e9ecef; padding: 16px; vertical-align: top; background: #f8fafc;">
                            ${escapeHtml(question)}
                        </td>
                        <td style="width: 65%; padding: 16px; vertical-align: top;">
                            ${answer}
                        </td>
                    </tr>
                `;
            }
        });
    }

    if (!responseData) {
        responseData = '<tr><td colspan="2" style="text-align: center; color: #999; padding: 40px 20px;">No response data available</td></tr>';
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
    
    const formTitle = '{{ form.title if form.title else "Form" }}';
    const eventName = '{{ event.name if event.name else "Event" }}';
    const userName = '{{ session.username if session.username else "User" }}';
    const userEmail = '{{ session.email if session.email else "No email" }}';
    const formId = '{{ form.id if form.id else "0000" }}'.substring(0, 8);
    
    const verificationId = 'VER-' + formId + '-' + responseNumber + '-' + (responseId ? responseId.substring(0, 8) : '00000000');
    
    // ENHANCED QR CODE SECTION
    let qrSection = '';
    if (qrCodeData) {
        qrSection = `
            <div style="page-break-inside: avoid; margin: 50px 0; padding: 30px; background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%); border: 2px solid #e2e8f0; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.05);">
                <div style="display: flex; flex-wrap: wrap; gap: 40px; align-items: center;">
                    <div style="flex: 1; min-width: 300px;">
                        <div style="background: white; padding: 25px; border-radius: 10px; border: 1px solid #e2e8f0;">
                            <h3 style="color: #4361ee; margin-bottom: 20px; font-size: 16pt; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                                <i class="bi bi-shield-check"></i> Document Verification
                            </h3>
                            <p style="font-size: 11pt; color: #4a5568; line-height: 1.7; margin-bottom: 20px;">
                                This document is electronically verified. Scan the QR code to validate authenticity through the ${BRAND_NAME} verification system.
                            </p>
                            <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; border: 1px solid #b3e0ff; margin-top: 20px;">
                                <div style="display: grid; grid-template-columns: auto 1fr; gap: 12px; align-items: center; margin-bottom: 15px;">
                                    <div style="font-weight: 700; color: #4361ee; font-size: 10pt;">Verification ID:</div>
                                    <div style="font-family: 'Courier New', monospace; background: white; padding: 8px 15px; border-radius: 6px; border: 1px solid #4361ee; font-weight: 600; letter-spacing: 0.5px; font-size: 10pt;">
                                        ${verificationId}
                                    </div>
                                    
                                    <div style="font-weight: 700; color: #4361ee; font-size: 10pt;">Generated:</div>
                                    <div style="font-weight: 600; font-size: 10pt;">${formattedDate}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <div style="background: white; padding: 25px; border-radius: 10px; border: 1px solid #e2e8f0; display: inline-block; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">
                            <div style="font-size: 9pt; color: #4361ee; margin-bottom: 15px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase;">
                                SCAN TO VERIFY
                            </div>
                            <img src="${qrCodeData}" alt="Verification QR Code" 
                                 style="width: 180px; height: 180px; border: 1px solid #e2e8f0; display: block; margin: 0 auto; padding: 10px; background: white;">
                            <div style="margin-top: 20px;">
                                <div style="font-size: 9pt; color: #64748b; margin-bottom: 5px;">Verification ID</div>
                                <div style="font-family: 'Courier New', monospace; font-size: 9pt; background: #f8fafc; padding: 8px; border-radius: 6px; word-break: break-all;">
                                    ${verificationId}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <h5 style="color: #4361ee; margin-bottom: 15px; font-size: 12pt; display: flex; align-items: center; gap: 10px;">
                        <i class="bi bi-info-circle"></i> Verification Instructions
                    </h5>
                    <ul style="font-size: 10pt; color: #4a5568; margin: 0; padding-left: 20px; line-height: 1.7;">
                        <li>Open smartphone camera or QR code scanner application</li>
                        <li>Position camera to focus on QR code above</li>
                        <li>Follow the link to ${BRAND_NAME}'s verification portal</li>
                        <li>Confirm verification status shows "ACTIVE & VALID"</li>
                    </ul>
                </div>
            </div>
        `;
    }
    
    // PROFESSIONAL WATERMARK WITH BRAND LOGO
    const watermark = `
        <div style="
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            opacity: 0.03;
            pointer-events: none;
            z-index: 999;
            user-select: none;
            text-align: center;
        ">
            <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                <div style="width: 300px; height: 100px; background: url('${BRAND_LOGO_URL}') no-repeat center center; background-size: contain; filter: grayscale(100%) opacity(20%);"></div>
                <div style="font-size: 24px; font-weight: 900; color: #4361ee; letter-spacing: 2px; opacity: 0.5;">
                    ${BRAND_NAME}
                </div>
                <div style="font-size: 12px; font-weight: 600; color: #3a0ca3; opacity: 0.4;">
                    ${BRAND_SLOGAN}
                </div>
            </div>
        </div>
    `;
    
    // ENHANCED FOOTER WITH BRAND LOGO
    const footer = `
        <div style="
            margin-top: 60px;
            padding-top: 25px;
            border-top: 2px solid #e9ecef;
            text-align: center;
            font-size: 9pt;
            color: #64748b;
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
        ">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px;">
                <div style="width: 30px; height: 30px; background: url('${BRAND_LOGO_URL}') no-repeat center center; background-size: contain;"></div>
                <div style="font-size: 14pt; font-weight: 900; color: #4361ee; letter-spacing: 2px;">
                    ${BRAND_NAME}
                </div>
            </div>
            <p style="margin: 5px 0; font-size: 9pt;">${BRAND_SLOGAN}</p>
            <div style="display: flex; justify-content: center; gap: 20px; margin: 10px 0; font-size: 8pt;">
                <span>
                    <strong>Generated:</strong> ${formattedDate}
                </span>
                <span></span>
            </div>
            <p style="margin: 5px 0; font-size: 8pt; color: #94a3b8;">
                 ${new Date().getFullYear()} ${BRAND_NAME}. All rights reserved.  This document is confidential and intended for authorized recipients only.
            </p>
        </div>
    `;
    
    // PROFESSIONAL HEADER DESIGN WITH BRANDING
    const header = `
        <div style="
            border-bottom: 3px solid #4361ee;
            padding-bottom: 30px;
            margin-bottom: 40px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            padding: 30px 30px 20px 30px;
            border-radius: 12px 12px 0 0;
            position: relative;
            overflow: hidden;
        ">
            <!-- Header background accent -->
            <div style="
                position: absolute;
                top: 0;
                right: 0;
                width: 300px;
                height: 300px;
                background: linear-gradient(135deg, rgba(67, 97, 238, 0.05) 0%, rgba(114, 9, 183, 0.05) 100%);
                border-radius: 50%;
                transform: translate(150px, -150px);
                z-index: 0;
            "></div>
            
            <div style="position: relative; z-index: 1;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px;">
                    <div>
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                            <div style="width: 40px; height: 40px; background: url('${BRAND_LOGO_URL}') no-repeat center center; background-size: contain;"></div>
                            <div>
                                <h1 style="
                                    margin: 0;
                                    font-size: 24pt;
                                    font-weight: 900;
                                    background: linear-gradient(135deg, #4361ee 0%, #7209b7 100%);
                                    -webkit-background-clip: text;
                                    -webkit-text-fill-color: transparent;
                                    letter-spacing: 1px;
                                ">
                                    ${BRAND_NAME}
                                </h1>
                                <p style="margin: 0; font-size: 10pt; color: #64748b; font-weight: 500;">
                                    ${BRAND_SLOGAN}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div style="
                        background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
                        color: white;
                        padding: 8px 25px;
                        border-radius: 25px;
                        font-weight: 700;
                        font-size: 10pt;
                        box-shadow: 0 5px 15px rgba(67, 97, 238, 0.2);
                        letter-spacing: 1px;
                    ">
                        RESPONSE REPORT #${responseNumber}
                    </div>
                </div>
                
                <h2 style="
                    margin: 0 0 20px 0;
                    font-size: 20pt;
                    color: #2c3e50;
                    font-weight: 700;
                    border-left: 5px solid #4361ee;
                    padding-left: 20px;
                    background: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                ">
                    <i class="bi bi-card-checklist"></i> Response Analysis Report
                </h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                        <div style="font-size: 9pt; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Event</div>
                        <div style="font-weight: 700; color: #4361ee; font-size: 12pt; display: flex; align-items: center; gap: 8px;">
                            <i class="bi bi-calendar-event"></i> ${escapeHtml(eventName)}
                        </div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                        <div style="font-size: 9pt; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Form</div>
                        <div style="font-weight: 700; color: #4361ee; font-size: 12pt; display: flex; align-items: center; gap: 8px;">
                            <i class="bi bi-file-text"></i> ${escapeHtml(formTitle)}
                        </div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                        <div style="font-size: 9pt; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Generated By</div>
                        <div style="font-weight: 700; color: #4361ee; font-size: 12pt; display: flex; align-items: center; gap: 8px;">
                            <i class="bi bi-person"></i> ${escapeHtml(userName)}
                        </div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                        <div style="font-size: 9pt; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Report Date</div>
                        <div style="font-weight: 700; color: #4361ee; font-size: 12pt; display: flex; align-items: center; gap: 8px;">
                            <i class="bi bi-clock"></i> ${formattedDate}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // ENHANCED RESPONSE TABLE DESIGN
    const responseTable = `
        <div style="margin: 40px 0;">
            <div style="
                background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
                color: white;
                padding: 18px 25px;
                border-radius: 10px 10px 0 0;
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0;
            ">
                <h3 style="margin: 0; font-size: 14pt; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                    <i class="bi bi-clipboard-data"></i> Response Details
                </h3>
                <div style="font-size: 10pt; opacity: 0.9;">
                    ${responseId ? `ID: ${responseId.substring(0, 8)}...` : 'No ID'}
                </div>
            </div>
            
            <div style="border: 1px solid #e2e8f0; border-radius: 0 0 10px 10px; overflow: hidden;">
                <table style="
                    width: 100%;
                    border-collapse: collapse;
                    margin: 0;
                ">
                    <thead>
                        <tr>
                            <th style="
                                background: #f8fafc;
                                color: #2c3e50;
                                padding: 16px 20px;
                                text-align: left;
                                font-weight: 700;
                                font-size: 10pt;
                                letter-spacing: 0.5px;
                                text-transform: uppercase;
                                border-bottom: 2px solid #e2e8f0;
                            ">Question</th>
                            <th style="
                                background: #f8fafc;
                                color: #2c3e50;
                                padding: 16px 20px;
                                text-align: left;
                                font-weight: 700;
                                font-size: 10pt;
                                letter-spacing: 0.5px;
                                text-transform: uppercase;
                                border-bottom: 2px solid #e2e8f0;
                            ">Response</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${responseData}
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    // SUMMARY SECTION
    const summarySection = `
        <div style="
            margin: 40px 0;
            padding: 25px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 10px;
            border: 2px solid #b3e0ff;
        ">
            <h3 style="
                color: #0369a1;
                margin-bottom: 20px;
                font-size: 16pt;
                display: flex;
                align-items: center;
                gap: 10px;
                border-bottom: 2px solid rgba(3, 105, 161, 0.2);
                padding-bottom: 10px;
            ">
                <i class="bi bi-file-earmark-text"></i> Report Summary
            </h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px;">
                <div style="text-align: center;">
                    <div style="font-size: 24pt; font-weight: 900; color: #4361ee; margin-bottom: 5px;">${responseNumber}</div>
                    <div style="font-size: 9pt; color: #64748b; text-transform: uppercase; letter-spacing: 1px;">Response Number</div>
                </div>
                
                <div style="text-align: center;">
                    <div style="font-size: 24pt; font-weight: 900; color: #10b981; margin-bottom: 5px;"></div>
                    <div style="font-size: 9pt; color: #64748b; text-transform: uppercase; letter-spacing: 1px;">Verification</div>
                </div>
                
                <div style="text-align: center;">
                    <div style="font-size: 24pt; font-weight: 900; color: #f59e0b; margin-bottom: 5px;">${formattedDate.split(',')[0]}</div>
                    <div style="font-size: 9pt; color: #64748b; text-transform: uppercase; letter-spacing: 1px;">Submission Date</div>
                </div>
                
                <div style="text-align: center;">
                    <div style="font-size: 24pt; font-weight: 900; color: #ef4444; margin-bottom: 5px;">${responseId ? 'Yes' : 'No'}</div>
                    <div style="font-size: 9pt; color: #64748b; text-transform: uppercase; letter-spacing: 1px;">ID Assigned</div>
                </div>
            </div>
        </div>
    `;
    
    const printHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Response Report #${responseNumber} - ${escapeHtml(formTitle)} - ${BRAND_NAME}</title>
            <meta charset="UTF-8">
            <style>
                @page { 
                    margin: 0.5in;
                    @top-center {
                        content: "${escapeHtml(eventName)} - ${escapeHtml(formTitle)}";
                        font-size: 9pt;
                        color: #64748b;
                        font-weight: 600;
                    }
                    @bottom-center {
                        content: "${BRAND_NAME}  Page " counter(page) " of " counter(pages);
                        font-size: 9pt;
                        color: #64748b;
                        font-weight: 600;
                    }
                }
                
                body { 
                    font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif; 
                    font-size: 11pt; 
                    line-height: 1.6; 
                    color: #2c3e50; 
                    margin: 0; 
                    padding: 20px; 
                    background: #fff;
                    position: relative;
                }
                
                .print-container { 
                    max-width: 900px; 
                    margin: 0 auto; 
                    position: relative;
                    z-index: 1;
                }
                
                @media print {
                    body { 
                        font-size: 10pt !important; 
                        background: white;
                    }
                    .no-print { 
                        display: none !important; 
                    }
                    .page-break {
                        page-break-before: always;
                    }
                    .avoid-break {
                        page-break-inside: avoid;
                    }
                    .watermark {
                        opacity: 0.02 !important;
                    }
                }
                
                /* Professional table styling */
                table {
                    border-collapse: collapse;
                    width: 100%;
                    margin: 20px 0;
                }
                
                th, td {
                    border: 1px solid #e2e8f0;
                    padding: 14px 18px;
                    text-align: left;
                    vertical-align: top;
                }
                
                th {
                    background: #f8fafc;
                    font-weight: 600;
                    color: #2c3e50;
                    border-bottom: 2px solid #4361ee;
                }
                
                tr:nth-child(even) {
                    background: #f8fafc;
                }
                
                tr:hover {
                    background: #f0f9ff;
                }
                
                /* Professional typography */
                h1, h2, h3, h4 {
                    color: #2c3e50;
                    font-weight: 600;
                    margin-top: 0;
                }
                
                .status-badge {
                    display: inline-block;
                    padding: 4px 12px;
                    border-radius: 20px;
                    font-size: 9pt;
                    font-weight: 600;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                
                .status-verified {
                    background: #10b981;
                    color: white;
                }
                
                .status-pending {
                    background: #f59e0b;
                    color: white;
                }
                
                .status-error {
                    background: #ef4444;
                    color: white;
                }
                
                .text-primary {
                    color: #4361ee !important;
                }
                
                .text-success {
                    color: #10b981 !important;
                }
                
                .text-warning {
                    color: #f59e0b !important;
                }
                
                .text-danger {
                    color: #ef4444 !important;
                }
                
                /* Code blocks */
                code {
                    font-family: 'Courier New', monospace;
                    background: #f8fafc;
                    padding: 2px 6px;
                    border-radius: 4px;
                    border: 1px solid #e2e8f0;
                    color: #4361ee;
                    font-weight: 600;
                }
                
                /* Print optimization */
                .print-optimized {
                    -webkit-print-color-adjust: exact;
                    print-color-adjust: exact;
                }
                
                /* Brand colors */
                .brand-primary {
                    color: #4361ee !important;
                }
                
                .brand-secondary {
                    color: #7209b7 !important;
                }
                
                .brand-gradient {
                    background: linear-gradient(135deg, #4361ee 0%, #7209b7 100%);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                }
            </style>
        </head>
        <body>
            ${watermark}
            
            <div class="print-container">
                ${header}
                
                ${summarySection}
                
                ${responseTable}
                
                ${qrSection}
                
                ${footer}
            </div>
            
            <script>
                setTimeout(function() { 
                    window.print(); 
                }, 1000);
                
                window.onafterprint = function() { 
                    setTimeout(function() { 
                        window.close(); 
                    }, 500); 
                };
            <\/script>
        </body>
        </html>
    `;

    const isMobile = /iPhone|iPad|iPod|Android|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isChrome = /Chrome/.test(navigator.userAgent);
    
    if (isMobile) {
        showPrintModalMobile(printHTML, isChrome);
    } else {
        printUsingIframe(printHTML);
    }
}

function printUsingIframe(content) {
    const iframe = document.createElement('iframe');
    iframe.style.position = 'fixed';
    iframe.style.right = '0';
    iframe.style.bottom = '0';
    iframe.style.width = '0';
    iframe.style.height = '0';
    iframe.style.border = 'none';
    iframe.id = 'print-iframe';
    
    document.body.appendChild(iframe);
    
    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
    iframeDoc.open();
    iframeDoc.write(content);
    iframeDoc.close();
    
    setTimeout(function() {
        try {
            iframe.contentWindow.focus();
            iframe.contentWindow.print();
        } catch (e) {
            console.error('Print failed:', e);
            const printWindow = window.open('', '_blank');
            printWindow.document.write(content);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(function() {
                printWindow.print();
            }, 500);
        }
    }, 1000);
}

function showPrintModalMobile(content, isChrome) {
    const modal = document.createElement('div');
    modal.id = 'print-preview-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; overflow-y: auto;';
    
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = ' Close';
    closeBtn.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; z-index: 10000;';
    closeBtn.onclick = function() {
        modal.remove();
        document.body.style.overflow = '';
    };
    
    const printBtn = document.createElement('button');
    printBtn.innerHTML = ' Print';
    printBtn.style.cssText = 'position: fixed; top: 10px; left: 10px; background: #4361ee; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; z-index: 10000;';
    printBtn.onclick = function() {
        const printWindow = window.open('', '_blank');
        printWindow.document.write(content);
        printWindow.document.close();
        
        setTimeout(function() {
            try {
                printWindow.print();
            } catch (e) {
                alert('To print on mobile:\n1. Tap the three dots menu ()\n2. Tap "Print"\n3. Select your printer\n\nOr use the Share button and select Print');
            }
        }, 500);
    };
    
    const contentDiv = document.createElement('div');
    contentDiv.innerHTML = content;
    contentDiv.style.padding = '60px 20px 20px 20px';
    
    modal.appendChild(closeBtn);
    modal.appendChild(printBtn);
    modal.appendChild(contentDiv);
    
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
}

// ===== HELPER FUNCTIONS =====
function escapeHtml(text) {
    if (!text) return '';
    return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function copyFormUrl() {
    const formUrl = document.getElementById('form-url');
    formUrl.select();
    navigator.clipboard.writeText(formUrl.value).then(function() {
        const toast = new bootstrap.Toast(document.getElementById('copyToast'));
        toast.show();
    }).catch(function(err) {
        console.error('Could not copy text: ', err);
        alert('Failed to copy URL. Please select and copy manually.');
    });
}

function sendTestNotification(eventId, formId) {
    if (confirm('Send a test form end notification to yourself?')) {
        showLoading('Sending test notification...');
        fetch('/send_test_notification/' + eventId + '/' + formId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            hideLoading();
            if (data.success) {
                showAlert('Test notification sent! Check your email inbox.', 'success');
            } else {
                showAlert('Error: ' + data.error, 'danger');
            }
        })
        .catch(function(error) {
            hideLoading();
            showAlert('Error sending test notification: ' + error.message, 'danger');
        });
    }
}

function showAlert(message, type) {
    let container = document.getElementById('alertContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'alertContainer';
        container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
        document.body.appendChild(container);
    }
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    
    container.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function showLoading(message) {
    let loadingDiv = document.getElementById('loading-overlay');
    if (!loadingDiv) {
        loadingDiv = document.createElement('div');
        loadingDiv.id = 'loading-overlay';
        loadingDiv.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 9999;';
        document.body.appendChild(loadingDiv);
    }
    
    loadingDiv.innerHTML = `
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="ms-3 text-light">${message}</div>
    `;
}

function hideLoading() {
    const loadingDiv = document.getElementById('loading-overlay');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

// ===== BULK ACTIONS FUNCTIONS =====
function updateBulkActions() {
    const selectedCount = document.getElementById('selectedCount');
    const bulkActions = document.getElementById('bulkActions');
    
    if (!selectedCount || !bulkActions) {
        return;
    }
    
    const checkboxes = document.querySelectorAll('.response-checkbox');
    const checked = document.querySelectorAll('.response-checkbox:checked');
    
    selectedCount.textContent = checked.length;
    
    if (checked.length > 0) {
        bulkActions.style.display = 'flex';
    } else {
        bulkActions.style.display = 'none';
    }
    
    const selectAll = document.getElementById('selectAllResponses');
    if (selectAll) {
        if (checkboxes.length === checked.length) {
            selectAll.checked = true;
            selectAll.indeterminate = false;
        } else if (checked.length > 0) {
            selectAll.checked = false;
            selectAll.indeterminate = true;
        } else {
            selectAll.checked = false;
            selectAll.indeterminate = false;
        }
    }
}

function deleteSelectedResponses() {
    const selectedIds = Array.from(document.querySelectorAll('.response-checkbox:checked'))
        .map(function(checkbox) {
            return checkbox.value;
        });
    
    if (selectedIds.length === 0) {
        showAlert('Please select at least one response to delete.', 'warning');
        return;
    }
    
    if (confirm('Are you sure you want to delete ' + selectedIds.length + ' selected response(s)?')) {
        showLoading('Deleting selected responses...');
        fetch('/delete_selected_responses/{{ event.id }}/{{ form.id }}', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ response_ids: selectedIds })
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            hideLoading();
            if (data.success) {
                showAlert(data.deleted_count + ' response(s) deleted successfully!', 'success');
                setTimeout(function() {
                    window.location.reload();
                }, 1500);
            } else {
                showAlert('Error: ' + data.error, 'danger');
            }
        })
        .catch(function(error) {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        });
    }
}

function clearSelection() {
    document.querySelectorAll('.response-checkbox').forEach(function(checkbox) {
        checkbox.checked = false;
    });
    updateBulkActions();
}

// ===== EVENT LISTENERS =====
document.addEventListener('DOMContentLoaded', function() {
    // Delete form confirmation
    const confirmDelete = document.getElementById('confirmDelete');
    if (confirmDelete) {
        confirmDelete.addEventListener('change', function() {
            const deleteButton = document.getElementById('deleteFormButton');
            if (deleteButton) {
                deleteButton.disabled = !this.checked;
            }
        });
    }
// ===== CHAT FUNCTIONS FOR VOLUNTEER DASHBOARD =====

let chatRefreshInterval = null;

// Function to start chat auto-refresh
function startChatRefresh() {
    if (chatRefreshInterval) {
        clearInterval(chatRefreshInterval);
    }
    
    // Refresh chat every 3 seconds
    chatRefreshInterval = setInterval(() => {
        if (volunteerModeEnabled) {
            loadChatMessages();
        }
    }, 3000); // 3 seconds
    
    console.log('Chat refresh started (3s interval)');
}

// Function to stop chat refresh
function stopChatRefresh() {
    if (chatRefreshInterval) {
        clearInterval(chatRefreshInterval);
        chatRefreshInterval = null;
        console.log('Chat refresh stopped');
    }
}

// Function to load chat messages
async function loadChatMessages() {
    try {
        const response = await fetch(`/get_chat_messages/{{ event.id }}/{{ form.id }}`);
        const data = await response.json();
        
        if (data.success) {
            updateChatUI(data.messages);
        }
    } catch (error) {
        console.error('Error loading chat messages:', error);
    }
}

// Function to update chat UI
function updateChatUI(messages) {
    const chatMessagesContainer = document.getElementById('chatMessages');
    if (!chatMessagesContainer) return;
    
    // Get current message IDs
    const currentMessageIds = new Set();
    chatMessagesContainer.querySelectorAll('.message').forEach(msg => {
        const msgId = msg.getAttribute('data-message-id');
        if (msgId) {
            currentMessageIds.add(msgId);
        }
    });
    
    // Add new messages
    let hasNewMessages = false;
    messages.forEach(msg => {
        if (!currentMessageIds.has(msg.id.toString())) {
            addChatMessage(msg, msg.sender === '{{ volunteer_name }}');
            hasNewMessages = true;
        }
    });
    
    // Scroll to bottom if there are new messages
    if (hasNewMessages) {
        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
    }
}

// Function to add individual chat message
function addChatMessage(messageData, isSent = false) {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
    messageDiv.setAttribute('data-message-id', messageData.id);
    
    const messageTime = new Date(messageData.timestamp);
    const timeString = messageTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    messageDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <strong>${messageData.sender}</strong>
            <small class="message-time">${timeString}</small>
        </div>
        ${messageData.message}
    `;
    
    chatMessages.appendChild(messageDiv);
}

// Function to send chat message
async function sendChatMessage() {
    const chatInput = document.getElementById('chatInput');
    const message = chatInput.value.trim();
    
    if (!message) return;
    
    chatInput.value = '';
    
    try {
        const response = await fetch('/volunteer_chat/{{ event.id }}/{{ form.id }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                volunteer_name: '{{ volunteer_name }}'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Add message immediately to UI
            addChatMessage({
                id: data.message.id || Date.now(),
                sender: '{{ volunteer_name }}',
                message: message,
                timestamp: new Date().toISOString()
            }, true);
            
            // Force refresh after sending
            setTimeout(() => {
                loadChatMessages();
            }, 1000);
        } else {
            showAlert('Error sending message: ' + data.error, 'danger');
        }
    } catch (error) {
        console.error('Chat error:', error);
        showAlert('Error sending message. Please try again.', 'danger');
    }
}

// Function to handle Enter key in chat
function handleChatKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendChatMessage();
    }
}


// Update the handleSessionEnded function
function handleSessionEnded(message) {
    // Stop all services
    stopVolunteerRefresh();
    stopSessionCheck();
    stopChatRefresh(); // ADD THIS LINE
    
    // Reset UI
    const toggle = document.getElementById('volunteerModeToggle');
    if (toggle) toggle.checked = false;
    
    const content = document.getElementById('volunteerModeContent');
    if (content) content.style.display = 'none';
    
    const status = document.getElementById('volunteerModeStatus');
    if (status) {
        status.textContent = 'Disabled';
        status.classList.remove('text-success');
        status.classList.add('text-muted');
    }
    
    // Clear data
    currentVolunteerCode = null;
    volunteerModeEnabled = false;
    clearVolunteerData();
    resetVolunteerCodeDisplay();
    
    // Show alert
    showAlert(message || 'Volunteer session has ended.', 'warning');
}

// Update cleanup function
function setupEventListeners() {
    const toggle = document.getElementById('volunteerModeToggle');
    const confirmDelete = document.getElementById('confirmDelete');
    const confirmDeleteAll = document.getElementById('confirmDeleteAll');
    
    if (toggle) {
        toggle.addEventListener('change', function() {
            localStorage.setItem('volunteerModeEnabled_{{ event.id }}_{{ form.id }}', this.checked);
        });
    }
    
    if (confirmDelete) {
        confirmDelete.addEventListener('change', function() {
            const deleteButton = document.getElementById('deleteFormButton');
            if (deleteButton) {
                deleteButton.disabled = !this.checked;
            }
        });
    }
    
    if (confirmDeleteAll) {
        confirmDeleteAll.addEventListener('change', function() {
            const deleteAllButton = document.getElementById('deleteAllResponsesButton');
            if (deleteAllButton) {
                deleteAllButton.disabled = !this.checked;
            }
        });
    }
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        stopVolunteerRefresh();
        stopSessionCheck();
        stopChatRefresh(); // ADD THIS LINE
    });
}

// ===== CSS FOR CHAT =====
function addChatStyles() {
    if (!document.getElementById('chatStyles')) {
        const style = document.createElement('style');
        style.id = 'chatStyles';
        style.textContent = `
            .chat-container {
                background: white;
                border-radius: 15px;
                height: 500px;
                display: flex;
                flex-direction: column;
                box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            }
            
            .chat-messages {
                flex: 1;
                overflow-y: auto;
                padding: 20px;
            }
            
            .chat-input {
                border-top: 1px solid #eee;
                padding: 15px;
                background: #f8f9fa;
                border-radius: 0 0 15px 15px;
            }
            
            .message {
                padding: 12px 15px;
                border-radius: 15px;
                margin-bottom: 10px;
                max-width: 80%;
                position: relative;
            }
            
            .message.sent {
                background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
                color: white;
                margin-left: auto;
                border-bottom-right-radius: 5px;
            }
            
            .message.received {
                background: #f0f2f5;
                color: #333;
                margin-right: auto;
                border-bottom-left-radius: 5px;
            }
            
            .message-time {
                font-size: 11px;
                opacity: 0.7;
                margin-top: 5px;
                display: block;
            }
            
            .verification-notification {
                background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
                border-left: 4px solid #0ea5e9;
            }
        `;
        document.head.appendChild(style);
    }
}

// Initialize chat styles
addChatStyles();
    // Delete all responses confirmation
    const confirmDeleteAll = document.getElementById('confirmDeleteAll');
    if (confirmDeleteAll) {
        confirmDeleteAll.addEventListener('change', function() {
            const deleteAllButton = document.getElementById('deleteAllResponsesButton');
            if (deleteAllButton) {
                deleteAllButton.disabled = !this.checked;
            }
        });
    }

    // Delete form
    const deleteFormButton = document.getElementById('deleteFormButton');
    if (deleteFormButton) {
        deleteFormButton.addEventListener('click', function() {
            if (confirm('Are you absolutely sure? This will permanently delete the form and all its data.')) {
                showLoading('Deleting form...');
                fetch('/delete_form/{{ event.id }}/{{ form.id }}', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    hideLoading();
                    if (data.success) {
                        showAlert('Form deleted successfully!', 'success');
                        setTimeout(function() {
                            window.location.href = '/dashboard';
                        }, 1500);
                    } else {
                        showAlert('Error: ' + data.error, 'danger');
                    }
                })
                .catch(function(error) {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
            }
        });
    }

    // Delete all responses
    const deleteAllResponsesButton = document.getElementById('deleteAllResponsesButton');
    if (deleteAllResponsesButton) {
        deleteAllResponsesButton.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete all {{ responses|length }} responses?')) {
                showLoading('Deleting responses...');
                fetch('/delete_all_responses/{{ event.id }}/{{ form.id }}', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    hideLoading();
                    if (data.success) {
                        showAlert(data.deleted_count + ' responses deleted successfully!', 'success');
                        setTimeout(function() {
                            window.location.reload();
                        }, 1500);
                    } else {
                        showAlert('Error: ' + data.error, 'danger');
                    }
                })
                .catch(function(error) {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
            }
        });
    }

    // Delete single response
    document.querySelectorAll('.delete-single-response').forEach(function(button) {
        button.addEventListener('click', function() {
            const responseId = this.getAttribute('data-response-id');
            if (confirm('Are you sure you want to delete this response?')) {
                showLoading('Deleting response...');
                fetch('/delete_response/{{ event.id }}/{{ form.id }}/' + responseId, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    hideLoading();
                    if (data.success) {
                        showAlert('Response deleted successfully!', 'success');
                        setTimeout(function() {
                            window.location.reload();
                        }, 1500);
                    } else {
                        showAlert('Error: ' + data.error, 'danger');
                    }
                })
                .catch(function(error) {
                    hideLoading();
                    showAlert('Error: ' + error.message, 'danger');
                });
            }
        });
    });

    // Bulk response selection
    const selectAllResponses = document.getElementById('selectAllResponses');
    if (selectAllResponses) {
        selectAllResponses.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.response-checkbox');
            checkboxes.forEach(function(checkbox) {
                checkbox.checked = this.checked;
            }.bind(this));
            updateBulkActions();
        });
    }

    document.querySelectorAll('.response-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('change', updateBulkActions);
    });

    // Search input Enter key
    const searchInput = document.getElementById('verificationSearch');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchVerification();
            }
        });
    }
    
    // Copy Response ID buttons
    document.querySelectorAll('.btn-copy-id').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            const responseId = this.getAttribute('data-id');
            
            navigator.clipboard.writeText(responseId).then(() => {
                const originalHTML = this.innerHTML;
                this.innerHTML = '<i class="bi bi-check"></i>';
                this.classList.remove('btn-outline-secondary');
                this.classList.add('btn-outline-success');
                
                setTimeout(() => {
                    this.innerHTML = originalHTML;
                    this.classList.remove('btn-outline-success');
                    this.classList.add('btn-outline-secondary');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        });
    });

    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Initial bulk actions update
    updateBulkActions();
});
</script>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="copyToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-primary text-white">
            <i class="bi bi-clipboard-check me-2"></i>
            <strong class="me-auto">Copied!</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            Form URL copied to clipboard
        </div>
    </div>
</div>

<!-- Alert Container -->
<div id="alertContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

{% endblock %}
